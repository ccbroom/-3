<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیستم پیشرفته مدیریت بردهای تعمیری</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
<link rel="stylesheet" href="https://unpkg.com/simplebar@latest/dist/simplebar.css">
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<script src="https://unpkg.com/simplebar@latest/dist/simplebar.min.js"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/fa.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
        --primary-color: #4361ee;
        --secondary-color: #3a0ca3;
        --success-color: #4cc9f0;
        --danger-color: #f72585;
        --warning-color: #f8961e;
        --info-color: #4895ef;
        --light-color: #f8f9fa;
        --dark-color: #212529;
        --sidebar-width: 260px;
        --glass-bg: rgba(255, 255, 255, 0.08);
        --glass-border: rgba(255, 255, 255, 0.1);
        --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }


     /* رفع مشکلات نمایش مودال */
     #userEditModal {
        display: none ;
        opacity: 0;
        transition: opacity 0.3s;
    }
    #userEditModal.show {
        display: block ;
        opacity: 1 ;
    }
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0,0,0,0.5);
    }

body {
    background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
    font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
   
    color: #f8f9fa;
    transition: all 0.3s;
    min-height: 100vh;
    overflow-x: hidden;
    margin: 0;
    padding: 0;
}

.main-container {
    display: none;
    opacity: 0;
    transition: all 0.4s ease;
    padding-top: 0;
}

.main-content {
    margin-right: var(--sidebar-width);
    padding: 20px;
    transition: all 0.3s;
    min-height: 100vh;
}

.custom-scrollbar {
    scrollbar-width: thin;
    scrollbar-color: var(--primary-color) rgba(255, 255, 255, 0.1);
}

.custom-scrollbar::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: var(--primary-color);
    border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: var(--secondary-color);
}

.sidebar {
    background: rgba(15, 12, 41, 0.9);
    backdrop-filter: blur(12px);
    color: white;
    height: 100vh;
    position: fixed;
    width: var(--sidebar-width);
    padding-top: 10px;
    box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    transition: all 0.3s;
    border-right: 1px solid rgba(255, 255, 255, 0.05);
    top: 0;
}

.toggle-sidebar {
    position: fixed;
    right: 20px;
    top: 20px;
    z-index: 1100;
    background: var(--primary-color);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    cursor: pointer;
    transition: all 0.3s;
}

.login-container {
    max-width: 450px;
    margin: 0 auto;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(12px);
    border-radius: 16px;
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transform: translateY(0);
    opacity: 1;
    transition: all 0.4s ease;
}

.card-header {
    background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
    color: white;
    border-radius: 12px 12px 0 0 !important;
    padding: 15px 20px;
    font-weight: 600;
    font-size: 1rem;
    border-bottom: none;
}

.dashboard-stats {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.stat-card {
    padding: 15px;
    border-radius: 12px;
    text-align: center;
    transition: all 0.3s;
    background: rgba(30, 30, 60, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.05);
}

.stat-card .stat-icon {
    font-size: 2rem;
    margin-bottom: 10px;
    color: var(--primary-color);
}

.stat-card .stat-value {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 5px;
}

.stat-card .stat-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
}

/* برای نمایش بهتر در موبایل */
@media (max-width: 992px) {
    .sidebar {
        margin-right: -280px;
    }
    
    .sidebar.show {
        margin-right: 0;
    }
    
    .main-content {
        margin-right: 0;
        padding: 15px;
    }
    
    .dashboard-stats {
        grid-template-columns: 1fr;
    }
    
    .stat-card {
        padding: 15px;
    }
    
    .stat-card .stat-icon {
        font-size: 1.8rem;
    }
    
    .stat-card .stat-value {
        font-size: 1.6rem;
    }
}
        
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .login-container {
            max-width: 450px;
            margin: 0 auto;
            padding: 2.5rem;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: translateY(0);
            opacity: 1;
            transition: all 0.4s ease;
        }
        
        .login-container.hide {
            transform: translateY(-20px);
            opacity: 0;
            display: none;
        }
        
        .main-container {
            display: none;
            opacity: 0;
            transition: all 0.4s ease;
        }
        
        .main-container.show {
            display: block;
            opacity: 1;
        }
        
        .sidebar {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(12px);
            color: white;
            height: 100vh;
            position: fixed;
            width: var(--sidebar-width);
            padding-top: 20px;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: all 0.3s;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .sidebar-collapsed {
            margin-right: -240px;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
            border-radius: 8px;
            padding: 12px 20px;
            transition: all 0.2s;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar .nav-link::before {
            content: '';
            position: absolute;
            right: -100%;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: all 0.6s;
        }
        
        .sidebar .nav-link:hover::before {
            right: 100%;
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: linear-gradient(90deg, rgba(67, 97, 238, 0.3), transparent);
            color: white;
            transform: translateX(-5px);
        }
        
        .sidebar .nav-link i {
            margin-left: 10px;
            font-size: 1.1rem;
        }
        
        .main-content {
            margin-right: var(--sidebar-width);
            padding: 30px;
            transition: all 0.3s;
            min-height: 100vh;
        }
        
        .main-content-expanded {
            margin-right: 40px;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            transition: all 0.3s;
            overflow: hidden;
            background: rgba(30, 30, 60, 0.6);
            color: #f8f9fa;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .card-header {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 12px 12px 0 0 !important;
            padding: 18px 25px;
            font-weight: 600;
            font-size: 1.1rem;
            border-bottom: none;
        }
        
        .btn-primary {
            background: var(--primary-color);
            border-color: var(--primary-color);
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary:hover {
            background: var(--secondary-color);
            border-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-danger {
            background: var(--danger-color);
            border-color: var(--danger-color);
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .btn-danger {
    background: var(--danger-color);
    border-color: var(--danger-color);
    padding: 10px 24px;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-danger:hover {
    background: #d11a2d;
    border-color: #d11a2d;
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

        .btn-success {
            background: var(--success-color);
            border-color: var(--success-color);
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .table {
            color: #f8f9fa;
        }
        
        .table th {
            background: rgba(67, 97, 238, 0.2);
            font-weight: 600;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .table td {
            padding: 12px 15px;
            vertical-align: middle;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .table-hover tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(255, 255, 255, 0.03);
        }
        
        .qr-code {
            display: inline-block;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            margin: 10px 0;
            border-radius: 8px;
        }
        
        .file-upload-container {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .file-upload-container:hover {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .file-upload-container i {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 8px 0;
            background: rgba(30, 30, 60, 0.6);
            border-radius: 8px;
            color: #f8f9fa;
            text-decoration: none;
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .file-item:hover {
            background: rgba(67, 97, 238, 0.2);
            transform: translateX(3px);
        }
        
        .file-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .low-stock {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 25px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 12px;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .search-box input {
            padding-right: 15px;
            padding-left: 40px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: 45px;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.05);
            color: #f8f9fa;
        }
        
        .search-box input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
            background: rgba(255, 255, 255, 0.1);
            color: #f8f9fa;
        }
        
        .part-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .part-item:last-child {
            border-bottom: none;
        }
        
        .part-actions {
            display: flex;
            gap: 8px;
        }
        
        .part-quantity {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .part-quantity input {
            width: 70px;
            text-align: center;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            color: #f8f9fa;
        }
        
        .form-control, .form-select {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f8f9fa;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
            background: rgba(255, 255, 255, 0.1);
            color: #f8f9fa;
        }
        
        .alert {
            border-radius: 8px;
            padding: 15px;
            border: none;
        }
        
        .tab-content {
            padding: 20px 0;
        }
        
        .nav-tabs {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.7);
            border: none;
            padding: 12px 20px;
            font-weight: 500;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
            background: transparent;
            margin-bottom: -1px;
        }
        
        .nav-tabs .nav-link:hover {
            border-color: transparent;
            color: var(--primary-color);
            background: rgba(67, 97, 238, 0.1);
        }
        
        .nav-tabs .nav-link.active {
            color: white;
            font-weight: 600;
            background: rgba(67, 97, 238, 0.2);
            border-bottom: 3px solid var(--primary-color);
        }
        
        .part-details {
            background: rgba(30, 30, 60, 0.6);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .part-details h5 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .detail-label {
            font-weight: 600;
            width: 180px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .detail-value {
            flex: 1;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 30px;
        }
        
        .ongoing-work {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .ongoing-work:hover {
            background-color: rgba(67, 97, 238, 0.1) !important;
            transform: translateX(3px);
        }
        
        .toggle-sidebar {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 1100;
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toggle-sidebar:hover {
            background: var(--secondary-color);
            transform: rotate(90deg);
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 15px;
        }
        
        .user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .user-profile-info {
            color: white;
        }
        
        .user-profile-info h6 {
            margin-bottom: 0;
            font-weight: 600;
        }
        
        
        .user-profile-info small {
            opacity: 0.8;
            font-size: 0.8rem;
        }
        
        .modal-content {
            background: rgba(30, 30, 60, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #f8f9fa;
        }
        
        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn-close {
            filter: invert(1);
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        .badge-completed {
            background-color: rgba(76, 201, 240, 0.2);
            color: var(--success-color);
        }
        
        .badge-ongoing {
            background-color: rgba(248, 150, 30, 0.2);
            color: var(--warning-color);
        }
        
        .animate__animated {
            animation-duration: 0.5s;
        }
        
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .file-list {
    margin-top: 15px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 10px;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px;
    margin: 5px 0;
    background: rgba(30, 30, 60, 0.6);
    border-radius: 6px;
}

.file-link {
    color: var(--primary-color);
    text-decoration: none;
    flex-grow: 1;
}

.file-link:hover {
    text-decoration: underline;
}

.file-link i {
    margin-left: 5px;
}
        
        .stat-card {
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
            background: rgba(30, 30, 60, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .stat-card .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .stat-card .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-card .stat-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .report-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .report-actions .btn {
            border-radius: 8px;
        }

        #troubleshootingActionsText {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #f8f9fa;
    border-radius: 8px;
    padding: 10px;
    width: 100%;
    min-height: 120px;
    resize: vertical; /* امکان تغییر اندازه عمودی */
    transition: border 0.3s;
}

#troubleshootingActionsText:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
}
        
        .file-dropzone {
            border: 2px dashed rgba(67, 97, 238, 0.5);
            background: rgba(67, 97, 238, 0.1);
            padding: 30px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .file-dropzone.active {
            border-color: var(--success-color);
            background: rgba(76, 201, 240, 0.1);
        }
        
        .file-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        @page {
    size: A4;
    margin: 10mm;
}


    @media print {
    body * {
        visibility: hidden;
    }
    .printable-barcode, .printable-barcode * {
        visibility: visible;
    }
    .printable-barcode {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        text-align: center;
        padding: 20px;
    }
    .no-print {
        display: none !important;
    }
}

        .file-preview-item {
            position: relative;
            width: 120px;
            background: rgba(30, 30, 60, 0.6);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .file-preview-item img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        replaced-part-quantity {
    color: white !important;
    font-size: 0.9rem;
    margin-top: 5px;
}
        
        .file-preview-item .file-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: center;
        }
        
        .file-preview-item .remove-file {
            position: absolute;
            top: -8px;
            left: -8px;
            width: 24px;
            height: 24px;
            background: var(--danger-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
            border: none;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
        }
        
        .progress-thin {
            height: 5px;
        }
        
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) rgba(255, 255, 255, 0.1);
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: var(--secondary-color);
        }
        
        @media (max-width: 992px) {
            .sidebar {
                margin-right: -280px;
            }
            
            .sidebar.show {
                margin-right: 0;
            }
            
            .main-content {
                margin-right: 0;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
        }
        
        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in-right {
            animation: slideInRight 0.5s ease-in-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(67, 97, 238, 0); }
            100% { box-shadow: 0 0 0 0 rgba(67, 97, 238, 0); }
        }
         /* Backup Management Styles */
    #backupManagementModal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }
    
    #backupsTableBody tr {
        vertical-align: middle;
    }
    </style>
   
</head>
<body>
    <!-- Login Section - منتقل شده به بالای صفحه -->
    <div class="container-fluid d-flex align-items-center justify-content-center py-4" style="background: linear-gradient(135deg, #1a1a2e, #16213e);">
        <div class="login-container animate__animated animate__fadeIn">
            <div class="text-center mb-4">
                <i class="bi bi-motherboard" style="font-size: 3rem; color: var(--primary-color);"></i>
                <h3 class="mt-3">سیستم پیشرفته مدیریت بردهای تعمیری</h3>
                <p class="text-muted">نسخه پیشرفته با امکانات جدید</p>
            </div>
            <div class="mb-3">
                <label for="username" class="form-label">نام کاربری</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-4">
                <label for="password" class="form-label">رمز عبور</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <div id="loginError" class="alert alert-danger d-none"></div>
            <button type="button" class="btn btn-primary w-100" id="loginBtn">ورود به سیستم</button>
        </div>
    </div>

    <!-- Main Application Container -->
    <div class="main-container">
        <!-- Change Password Modal -->
        <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="changePasswordModalLabel">تغییر رمز عبور</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">رمز عبور فعلی</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">رمز عبور جدید</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">تکرار رمز عبور جدید</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <div id="passwordError" class="alert alert-danger d-none"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                        <button type="button" class="btn btn-primary" id="savePasswordBtn">ذخیره تغییرات</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management Modal -->
        <div class="modal fade" id="userManagementModal" tabindex="-1" aria-labelledby="userManagementModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userManagementModalLabel">مدیریت کاربران</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-4">
                            <button class="btn btn-success" id="addUserBtn"><i class="bi bi-plus"></i> افزودن کاربر جدید</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>نام کاربری</th>
                                        <th>نقش</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Users will be listed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    </div>
                </div>
            </div>
        </div>

       
      <!-- Add/Edit User Modal -->
<div class="modal fade" id="userEditModal" tabindex="-1" aria-labelledby="userEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userEditModalLabel">افزودن کاربر جدید</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="editUsername" class="form-label">نام کاربری</label>
                    <input type="text" class="form-control" id="editUsername" required>
                </div>
                <div class="mb-3">
                    <label for="editPassword" class="form-label">رمز عبور</label>
                    <input type="password" class="form-control" id="editPassword" required>
                </div>
                <div class="mb-3" id="adminCheckboxContainer" style="display: none;">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="editIsAdmin">
                        <label class="form-check-label" for="editIsAdmin">
                            دسترسی مدیر
                        </label>
                    </div>
                </div>
                <div id="userEditError" class="alert alert-danger d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                <button type="button" class="btn btn-primary" id="saveUserBtn">ذخیره کاربر</button>
            </div>
        </div>
    </div>
</div>

        <!-- Part Details Modal -->
        <div class="modal fade part-details-modal" id="partDetailsModal" tabindex="-1" aria-labelledby="partDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    
                    <div class="modal-body">
                        <div id="partDetailsContent">
                            <!-- Part details will be loaded here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>   
                        <button type="button" class="btn btn-success" id="exportExcelBtn">خروجی Excel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- File Preview Modal -->
        <div class="modal fade" id="filePreviewModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="filePreviewModalLabel">پیش‌نمایش فایل</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="filePreviewImage" src="" class="img-fluid" style="max-height: 70vh;">
                        <div id="filePreviewContent" class="mt-3"></div>
                        <a href="#" id="fileDownloadLink" class="btn btn-primary mt-3"><i class="bi bi-download"></i> دانلود فایل</a>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
                    </div>
                </div>
            </div>
        </div>
<!-- Backup Management Modal -->
<div class="modal fade" id="backupManagementModal" tabindex="-1" aria-labelledby="backupManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="backupManagementModalLabel">مدیریت پشتیبان‌گیری</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="backupToggle" checked>
                        <label class="form-check-label" for="backupToggle">پشتیبان‌گیری خودکار فعال باشد</label>
                    </div>
                    <button class="btn btn-primary me-2" id="createBackupBtn">
                        <i class="bi bi-download"></i> ایجاد پشتیبان الآن
                    </button>
                    <button class="btn btn-success" id="restoreBackupBtn">
                        <i class="bi bi-upload"></i> بازگردانی پشتیبان
                    </button>
                    <input type="file" id="backupFileInput" class="d-none" accept=".json">
                </div>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>تاریخ پشتیبان</th>
                                <th>تعداد بردها</th>
                                <th>تعداد قطعات</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody id="backupsTableBody">
                            <!-- لیست پشتیبان‌ها اینجا نمایش داده می‌شود -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">بستن</button>
            </div>
        </div>
    </div>
</div>
        <!-- Main Layout -->
        <div class="d-flex">
            <!-- Sidebar Toggle Button -->
            <button class="toggle-sidebar d-none d-lg-block">
                <i class="bi bi-list"></i>
            </button>

            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="user-profile">
                    <img src="https://ui-avatars.com/api/?name=User&background=3498db&color=fff" alt="User" id="userProfileImage">
                    <div class="user-profile-info">
                        <h6 id="sidebarUsername">کاربر</h6>
                        <small id="sidebarUserRole">مدیر سیستم</small>
                    </div>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="dashboard">
                            <i class="bi bi-speedometer2"></i>
                            داشبورد
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="parts">
                            <i class="bi bi-motherboard"></i>
                            مدیریت کار
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="inventory">
                            <i class="bi bi-box-seam"></i>
                            موجودی انبار
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="reports">
                            <i class="bi bi-file-earmark-text"></i>
                            گزارشات
                        </a>
                    </li>
                    <li class="nav-item d-none" id="adminMenuItem">
                        <a class="nav-link" href="#" data-section="users">
                            <i class="bi bi-people"></i>
                            مدیریت کاربران
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="backupManagementBtn">
                            <i class="bi bi-cloud-arrow-down"></i>
                            مدیریت پشتیبان‌ها
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">
                            <i class="bi bi-box-arrow-left"></i>
                            خروج از سیستم
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Main Content -->
            <div class="main-content" id="mainContent">
                <!-- Dashboard Section -->
                <div id="dashboardSection">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">داشبورد مدیریت بردهای تعمیری</h2>
                        <div>
                            <span class="badge bg-primary"><i class="bi bi-person"></i> <span id="currentUserDisplay">admin</span></span>
                            <button class="btn btn-sm btn-outline-light ms-2" id="notificationsBtn">
                                <i class="bi bi-bell"></i>
                                <span class="notification-badge d-none">3</span>
                            </button>
                        </div>
                    </div>

                    <div class="dashboard-stats">
                        <div class="stat-card animate__animated animate__fadeInUp">
                            <div class="stat-icon"><i class="bi bi-motherboard"></i></div>
                            <div class="stat-value" id="totalPartsCount">0</div>
                            <div class="stat-label">کل بردهای ثبت شده</div>
                        </div>
                        <div class="stat-card animate__animated animate__fadeInUp animate__delay-1s">
                            <div class="stat-icon"><i class="bi bi-exclamation-triangle"></i></div>
                            <div class="stat-value text-danger" id="lowStockPartsCount">0</div>
                            <div class="stat-label">قطعات با موجودی کم</div>
                        </div>
                        <div class="stat-card animate__animated animate__fadeInUp animate__delay-2s">
                            <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                            <div class="stat-value text-success" id="completedPartsCount">0</div>
                            <div class="stat-label">بردهای تعمیر شده</div>
                        </div>
                        <div class="stat-card animate__animated animate__fadeInUp animate__delay-3s">
                            <div class="stat-icon"><i class="bi bi-clock"></i></div>
                            <div class="stat-value text-warning" id="ongoingPartsCount">0</div>
                            <div class="stat-label">کارهای در حال انجام</div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card animate__animated animate__fadeIn">
                                <div class="card-header">
                                    <i class="bi bi-clock-history"></i> آخرین بردهای ثبت شده
                                </div>
                                <div class="card-body custom-scrollbar" style="max-height: 300px; overflow-y: auto;">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>کد برد</th>
                                                    <th>نام برد</th>
                                                    <th>وضعیت</th>
                                                    <th>عملیات</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recentPartsTable">
                                                <!-- Recent parts will be listed here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 mt-4">
                            <div class="card animate__animated animate__fadeIn">
                                <div class="card-header">
                                    <i class="bi bi-tools"></i> کارهای در حال انجام
                                </div>
                                <div class="card-body custom-scrollbar" style="max-height: 300px; overflow-y: auto;">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>کد برد</th>
                                                    <th>نام برد</th>
                                                    <th>ثبت شده توسط</th>
                                                    <th>عملیات</th>
                                                </tr>
                                            </thead>
                                            <tbody id="ongoingWorksTable">
                                                <!-- Ongoing works will be listed here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

       <!-- Parts Management Section -->
       <div id="partsSection" class="d-none">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">مدیریت کار</h2>
            <div>
                <button class="btn btn-primary" id="addPartBtn"><i class="bi bi-plus"></i> افزودن برد جدید</button>
                <button class="btn btn-outline-light" id="scanQrBtn"><i class="bi bi-qr-code-scan"></i> اسکن QR</button>
            </div>
        </div>

        <ul class="nav nav-tabs" id="partsTabs">
            <li class="nav-item">
                <a class="nav-link active" data-bs-toggle="tab" href="#addPartTab">ثبت برد جدید</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-bs-toggle="tab" href="#partsListTab">لیست بردها</a>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="addPartTab">
                <div class="card">
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="partName" class="form-label">نام برد</label>
                            <input type="text" class="form-control" id="partName" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="workingVoltage" class="form-label">ولتاژ کاری (ولت)</label>
                                    <input type="number" class="form-control" id="workingVoltage">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="currentConsumption" class="form-label">جریان مصرفی (آمپر)</label>
                                    <input type="number" step="0.01" class="form-control" id="currentConsumption">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">کد برد</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="partCode" readonly>
                                <button class="btn btn-outline-secondary" type="button" id="generateCodeBtn">
                                    <i class="bi bi-arrow-repeat"></i> تولید کد
                                </button>
                            </div>
                            <div id="qrCodeContainer" class="mt-2 text-center"></div>
                            <button class="btn btn-secondary mt-2 w-100" id="printBarcodeBtn">
                                <i class="bi bi-printer"></i> پرینت بارکد
                            </button>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">تاریخ تولید</label>
                            <input type="text" class="form-control" id="productionDate">
                        </div>
                        
                        <div class="mb-3">
                            <label for="faultDescription" class="form-label">شرح عیب</label>
                            <textarea class="form-control" id="faultDescription" rows="3"></textarea>
                        </div>
                        
                        <button class="btn btn-primary w-100" id="savePartBtn">
                            <i class="bi bi-save"></i> ذخیره برد
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="partsListTab">
                <div class="search-box mb-3">
                    <i class="bi bi-search"></i>
                    <input type="text" class="form-control" id="partsListSearch" placeholder="جستجوی بردها بر اساس نام یا کد...">
                </div>
                <div class="card">
                    <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>کد برد</th>
                                        <th>نام برد</th>
                                        <th>ثبت شده توسط</th>
                                        <th>وضعیت</th>
                                        <th>عملیات</th>
                                    </tr>
                                </thead>
                                <tbody id="allPartsTable">
                                    <!-- All parts will be listed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

                    <!-- Inventory Management Section -->
                    <div id="inventorySection" class="d-none">
                        <h2 class="mb-4">مدیریت موجودی انبار</h2>
                        <div class="search-box mb-3">
                            <i class="bi bi-search"></i>
                            <input type="text" class="form-control" id="inventorySearch" placeholder="جستجوی قطعات...">
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-box-seam"></i> لیست قطعات و موجودی
                            </div>
                            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>نام قطعه</th>
                                                <th>موجودی</th>
                                                <th>وضعیت</th>
                                                <th>عملیات</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inventoryTable">
                                            <!-- Inventory items will be listed here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <i class="bi bi-plus-circle"></i> افزودن/ویرایش قطعه در انبار
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="inventoryPartName" class="form-label">نام قطعه</label>
                                        <input type="text" class="form-control" id="inventoryPartName">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="inventoryQuantity" class="form-label">تعداد</label>
                                        <input type="number" class="form-control" id="inventoryQuantity" min="0">
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary" id="saveInventoryBtn">ذخیره</button>
                        </div>
                    </div>
                </div>

                <!-- Reports Section -->
                <div id="reportsSection" class="d-none">
                    <h2 class="mb-4">گزارشات پیشرفته</h2>
                    
                    <div class="row">
                        <!-- گزارش بردها -->
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="bi bi-motherboard"></i> گزارش بردهای تعمیری
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" id="exportAllPartsBtn">
                                            <i class="bi bi-file-earmark-excel"></i> خروجی کلی تمام بردها
                                        </button>
                                        <button class="btn btn-success" id="exportCompletedPartsBtn">
                                            <i class="bi bi-file-earmark-excel"></i> خروجی بردهای تعمیر شده
                                        </button>
                                        <button class="btn btn-warning" id="exportOngoingPartsBtn">
                                            <i class="bi bi-file-earmark-excel"></i> خروجی بردهای در حال انجام
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- گزارش انبار -->
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header">
                                    <i class="bi bi-box-seam"></i> گزارش انبار
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" id="exportFullInventoryBtn">
                                            <i class="bi bi-file-earmark-excel"></i> خروجی کلی انبار
                                        </button>
                                        <button class="btn btn-danger" id="exportLowStockBtn">
                                            <i class="bi bi-file-earmark-excel"></i> خروجی موجودی کم
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- گزارش ماهانه -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-calendar-range"></i> گزارش ماهانه
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="reportYear" class="form-label">سال</label>
                                        <input type="number" class="form-control" id="reportYear" min="1400" max="1500" value="1402">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="reportMonth" class="form-label">ماه (اختیاری)</label>
                                        <select class="form-select" id="reportMonth">
                                            <option value="">همه ماه‌ها</option>
                                            <option value="1">فروردین</option>
                                            <option value="2">اردیبهشت</option>
                                            <option value="3">خرداد</option>
                                            <option value="4">تیر</option>
                                            <option value="5">مرداد</option>
                                            <option value="6">شهریور</option>
                                            <option value="7">مهر</option>
                                            <option value="8">آبان</option>
                                            <option value="9">آذر</option>
                                            <option value="10">دی</option>
                                            <option value="11">بهمن</option>
                                            <option value="12">اسفند</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="reportStatusFilter" class="form-label">وضعیت</label>
                                        <select class="form-select" id="reportStatusFilter">
                                            <option value="all">همه</option>
                                            <option value="completed">تعمیر شده</option>
                                            <option value="ongoing">در حال انجام</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary" id="exportMonthlyReportBtn">
                                <i class="bi bi-file-earmark-excel"></i> تولید گزارش ماهانه
                            </button>
                        </div>
                    </div>
                    
                    <!-- آمار و نمودارها -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-pie-chart"></i> آمار کارها
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="statsYear" class="form-label">سال</label>
                                        <input type="number" class="form-control" id="statsYear" min="1400" max="1500" value="1402">
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="worksChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-bar-chart"></i> آمار ماهانه
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="monthlyStatsYear" class="form-label">سال</label>
                                        <input type="number" class="form-control" id="monthlyStatsYear" min="1400" max="1500" value="1402">
                                    </div>
                                    <div class="chart-container">
                                        <canvas id="monthlyStatsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div id="usersSection" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 class="mb-0">مدیریت کاربران</h2>
                        <button class="btn btn-primary" id="openUserManagementBtn">
                            <i class="bi bi-people"></i> مدیریت کاربران
                        </button>
                    </div>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> برای مدیریت کاربران از دکمه بالا استفاده کنید.
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <script>
        // Initialize data structures
        let parts = JSON.parse(localStorage.getItem('parts')) || [];
        let inventory = JSON.parse(localStorage.getItem('inventory')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [{ 
            username: 'admin', 
            password: 'admin', 
            isAdmin: true, 
            changePassword: false,
            name: 'مدیر سیستم'
        }];
        let currentUser = null;
        let uploadedFiles = [];
        let currentPartId = null;
        let worksChart = null;
        let monthlyStatsChart = null;
        const partDetailsModal = new bootstrap.Modal(document.getElementById('partDetailsModal'));
        const userManagementModal = new bootstrap.Modal(document.getElementById('userManagementModal'));
        const filePreviewModal = new bootstrap.Modal(document.getElementById('filePreviewModal'));
        // متغیرهای پشتیبان‌گیری
         let backupInterval = 24 * 60 * 60 * 1000; // هر 24 ساعت
         let lastBackupTime = localStorage.getItem('lastBackupTime') || 0;
         let backupEnabled = localStorage.getItem('backupEnabled') !== 'false';
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            
            document.getElementById('productionDate').value = new Date().toLocaleDateString('fa-IR');
            document.getElementById('productionDate').addEventListener('change', function() {
    const dateRegex = /^[0-9]{4}\/[0-9]{2}\/[0-9]{2}$/;
    if (!dateRegex.test(this.value)) {
        showToast('فرمت تاریخ نامعتبر است. لطفاً از فرمت YYYY/MM/DD استفاده کنید', 'danger');
        this.value = new Date().toLocaleDateString('fa-IR');
    }
});

            // Check if users exist in localStorage, if not create admin user
            
            if (users.length === 0) {
                users = [{ 
                    username: 'admin', 
                    password: 'admin', 
                    isAdmin: true, 
                    changePassword: false,
                    name: 'مدیر سیستم'
                }];
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Initialize event listeners
            initEventListeners();
            // در بخش initEventListeners یا ابتدای اسکریپت این خط را اضافه کنید
const userEditModal = new bootstrap.Modal(document.getElementById('userEditModal'));

            
            // Initialize file dropzone
            initFileDropzone();
        });
        // تابع پشتیبان‌گیری
        function backupData(force = false) {
    try {
        // بررسی فعال بودن پشتیبان‌گیری
        if (localStorage.getItem('backupEnabled') === 'false' && !force) {
            console.log('سیستم پشتیبان‌گیری غیرفعال است');
            return false;
        }

        // ایجاد داده پشتیبان
        const backup = {
            parts: JSON.parse(localStorage.getItem('parts') || '[]'),
            inventory: JSON.parse(localStorage.getItem('inventory') || '[]'),
            users: JSON.parse(localStorage.getItem('users') || '[]'),
            timestamp: Date.now()
        };

        // ذخیره در localStorage
        const backupKey = `backup_${new Date().toISOString().replace(/[:.]/g, '-')}`;
        localStorage.setItem(backupKey, JSON.stringify(backup));
        localStorage.setItem('lastBackupTime', backup.timestamp);

        // ایجاد فایل دانلودی
        const blob = new Blob([JSON.stringify(backup, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_${new Date(backup.timestamp).toLocaleDateString('fa-IR')}.json`;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }, 100);

        console.log('پشتیبان با موفقیت ایجاد شد. کلید:', backupKey);
        return true;
    } catch (error) {
        console.error('خطا در ایجاد پشتیبان:', error);
        return false;
    }
}

// تابع بازگردانی پشتیبان
        function restoreBackup(backupData) {
    if (!backupData) return false;
    
    try {
        if (backupData.parts) {
            localStorage.setItem('parts', JSON.stringify(backupData.parts));
            parts = backupData.parts;
        }
        if (backupData.inventory) {
            localStorage.setItem('inventory', JSON.stringify(backupData.inventory));
            inventory = backupData.inventory;
        }
        if (backupData.users) {
            localStorage.setItem('users', JSON.stringify(backupData.users));
            users = backupData.users;
        }
        
        updateDashboard();
        updateInventoryTable();
        updatePartsList();
        updateUsersTable();
        
        return true;
    } catch (e) {
        console.error('خطا در بازگردانی پشتیبان:', e);
        return false;
    }
}

// تابع نمایش لیست پشتیبان‌ها
        function updateBackupsList() {
    const tableBody = document.getElementById('backupsTableBody');
    tableBody.innerHTML = '';
    
    // لیست تمام کلیدهای پشتیبان در localStorage
    const backups = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('backup_')) {
            try {
                const backup = JSON.parse(localStorage.getItem(key));
                backups.push({
                    key,
                    date: new Date(backup.timestamp),
                    partsCount: backup.parts.length,
                    inventoryCount: backup.inventory.length
                });
            } catch (e) {
                console.error('خطا در خواندن پشتیبان:', key, e);
            }
        }
    }
    
    // مرتب کردن بر اساس تاریخ (جدیدترین اول)
    backups.sort((a, b) => b.timestamp - a.timestamp);
    
    if (backups.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">هیچ پشتیبانی یافت نشد</td></tr>';
        return;
    }
    
    backups.forEach(backup => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${backup.date.toLocaleDateString('fa-IR')}</td>
            <td>${backup.partsCount}</td>
            <td>${backup.inventoryCount}</td>
            <td>
                <button class="btn btn-sm btn-primary restore-local-backup" data-backup-key="${backup.key}">
                    <i class="bi bi-arrow-counterclockwise"></i> بازگردانی
                </button>
                <button class="btn btn-sm btn-danger delete-backup" data-backup-key="${backup.key}">
                    <i class="bi bi-trash"></i> حذف
                </button>
                <button class="btn btn-sm btn-secondary download-backup" data-backup-key="${backup.key}">
                    <i class="bi bi-download"></i> دانلود
                </button>
            </td>
        `;
        tableBody.appendChild(row);
    });
    
    // اضافه کردن event listener برای دکمه‌ها
    document.querySelectorAll('.restore-local-backup').forEach(btn => {
        btn.addEventListener('click', () => {
            const backupKey = btn.dataset.backupKey;
            const backupData = JSON.parse(localStorage.getItem(backupKey));
            if (confirm('آیا از بازگردانی این پشتیبان مطمئن هستید؟ تمام داده‌های فعلی جایگزین خواهند شد.')) {
                if (restoreBackup(backupData)) {
                    showToast('پشتیبان با موفقیت بازگردانی شد', 'success');
                } else {
                    showToast('خطا در بازگردانی پشتیبان', 'danger');
                }
            }
        });
    });
    
    document.querySelectorAll('.delete-backup').forEach(btn => {
        btn.addEventListener('click', () => {
            const backupKey = btn.dataset.backupKey;
            if (confirm('آیا از حذف این پشتیبان مطمئن هستید؟')) {
                localStorage.removeItem(backupKey);
                updateBackupsList();
                showToast('پشتیبان با موفقیت حذف شد', 'success');
            }
        });
    });
    
    document.querySelectorAll('.download-backup').forEach(btn => {
        btn.addEventListener('click', () => {
            const backupKey = btn.dataset.backupKey;
            const backupData = localStorage.getItem(backupKey);
            const blob = new Blob([backupData], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${backupKey}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
    });
}

        function deletePart(partId) {
    if (confirm('آیا از حذف این برد اطمینان دارید؟ این عمل غیرقابل بازگشت است.')) {
        const part = parts.find(p => p.id === partId);
        if (part && part.files) {
            // آزادسازی URLهای فایل‌های این برد
            part.files.forEach(file => {
                try {
                    URL.revokeObjectURL(file.url);
                } catch (e) {
                    console.error('Error revoking file URL:', e);
                }
            });
        }
        
        parts = parts.filter(p => p.id !== partId);
        localStorage.setItem('parts', JSON.stringify(parts));
        
        showToast('برد با موفقیت حذف شد', 'success');
        updateDashboard();
        updatePartsList();
    }
}

        function initEventListeners() {


// گزارش‌گیری بردها
    document.getElementById('exportAllPartsBtn')?.addEventListener('click', exportAllPartsToExcel);
    document.getElementById('exportCompletedPartsBtn')?.addEventListener('click', () => exportPartsByStatus('completed'));
    document.getElementById('exportOngoingPartsBtn')?.addEventListener('click', () => exportPartsByStatus('ongoing'));
    
    // گزارش‌گیری انبار
    document.getElementById('exportFullInventoryBtn')?.addEventListener('click', () => exportInventoryReport(false));
    document.getElementById('exportLowStockBtn')?.addEventListener('click', () => exportInventoryReport(true));
    
    // گزارش ماهانه
    document.getElementById('exportMonthlyReportBtn')?.addEventListener('click', exportMonthlyPartsReport);
    
    // آمار و نمودارها
    document.getElementById('statsYear')?.addEventListener('change', generateWorksChart);
    document.getElementById('monthlyStatsYear')?.addEventListener('change', generateMonthlyStatsChart);



            // Backup functionality
            document.getElementById('saveInventoryBtn').addEventListener('click', saveInventoryItem);
            const inventorySearch = document.getElementById('inventorySearch');
if (inventorySearch) {
    inventorySearch.addEventListener('input', function() {
        const searchTerm = this.value.trim().toLowerCase();
        const rows = document.querySelectorAll('#inventoryTable tr');
        
        if (searchTerm.length === 0) {
            rows.forEach(row => row.style.display = '');
            return;
        }
        
        rows.forEach(row => {
            const partName = row.querySelector('td:first-child').textContent.toLowerCase();
            const quantity = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            
            if (partName.includes(searchTerm) || quantity.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
}
setupExportExcelButton();  
            document.getElementById('backupManagementBtn').addEventListener('click', () => {
    const backupModal = new bootstrap.Modal(document.getElementById('backupManagementModal'));
    backupModal.show();
    updateBackupsList();
});

document.getElementById('openUserManagementBtn').addEventListener('click', function() {
    userManagementModal.show();
    updateUsersTable();
});

document.getElementById('createBackupBtn').addEventListener('click', () => {
    backupData();
    showToast('پشتیبان با موفقیت ایجاد شد', 'success');
    updateBackupsList();
});

document.getElementById('backupToggle').addEventListener('change', (e) => {
    backupEnabled = e.target.checked;
    localStorage.setItem('backupEnabled', backupEnabled);
    showToast(`پشتیبان‌گیری خودکار ${backupEnabled ? 'فعال' : 'غیرفعال'} شد`, 'info');
});

document.getElementById('restoreBackupBtn').addEventListener('click', () => {
    document.getElementById('backupFileInput').click();
});

document.getElementById('backupFileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (event) => {
        try {
            const backupData = JSON.parse(event.target.result);
            if (confirm('آیا از بازگردانی این پشتیبان مطمئن هستید؟ تمام داده‌های فعلی جایگزین خواهند شد.')) {
                if (restoreBackup(backupData)) {
                    showToast('پشتیبان با موفقیت بازگردانی شد', 'success');
                } else {
                    showToast('خطا در بازگردانی پشتیبان', 'danger');
                }
            }
        } catch (error) {
            showToast('فایل پشتیبان نامعتبر است', 'danger');
            console.error(error);
        }
    };
    reader.readAsText(file);
});

$(function() {
    $(document).on('click', '#addUserBtn', function() {
        $('#userEditModal .modal-title').text('افزودن کاربر جدید');
        new bootstrap.Modal('#userEditModal').show();
    });
});

// Initialize backup system
backupData();
setInterval(backupData, backupInterval);
            // Login functionality
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            
            // Logout functionality
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Change password functionality
            document.getElementById('savePasswordBtn').addEventListener('click', handleChangePassword);
            
            // Navigation
            document.querySelectorAll('.nav-link[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                    
                    // Update active state
                    document.querySelectorAll('.nav-link').forEach(navLink => {
                        navLink.classList.remove('active');
                   
});
                    this.classList.add('active');
                    // اضافه کردن event listener برای دکمه‌های ثبت پایان کار
document.addEventListener('click', function(e) {
    if (e.target.closest('.complete-part-list')) {
        const partId = e.target.closest('.complete-part-list').dataset.partId;
        markAsComplete(partId);
    }
    
    if (e.target.closest('.complete-from-dashboard')) {
        const partId = e.target.closest('.complete-from-dashboard').dataset.partId;
        markAsComplete(partId);
    }
});
                    // Generate chart when reports section is shown
                    if (section === 'reports') {
                        generateWorksChart();
                        generateMonthlyStatsChart();
                    }
                });
            });
            
            // Parts management
            document.getElementById('generateCodeBtn').addEventListener('click', generatePartCode);
            document.getElementById('addUsedPartBtn').addEventListener('click', addUsedPart);
            document.getElementById('addReplacedPartBtn').addEventListener('click', addReplacedPart);
            document.getElementById('savePartBtn').addEventListener('click', savePart);
            document.getElementById('markAsCompleteBtn').addEventListener('click', markAsComplete);
            document.getElementById('searchPartBtn').addEventListener('click', searchPart);
            document.getElementById('partSearch').addEventListener('input', searchParts);
            document.getElementById('scanQrBtn').addEventListener('click', scanQrCode);
            
            // File upload
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // Inventory management
            document.getElementById('saveInventoryBtn').addEventListener('click', saveInventoryItem);
            
            // Reports
            document.getElementById('generateWorksReportBtn').addEventListener('click', generateWorksChart);    
            document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
            
            // User management
            document.getElementById('addUserBtn').addEventListener('click', addNewUser);
            document.getElementById('saveUserBtn').addEventListener('click', saveUser);
            document.getElementById('openUserManagementBtn').addEventListener('click', () => {
                userManagementModal.show();
                updateUsersTable();
            });
            
            // Part details modal        
            document.getElementById('exportExcelBtn').addEventListener('click', exportPartDetailsAsExcel);
            
            // Initialize production date
            document.getElementById('productionDate').value = new Date().toLocaleDateString('fa-IR');
            
            // Toggle sidebar
            document.querySelector('.toggle-sidebar').addEventListener('click', toggleSidebar);

            const closeBtn = document.querySelector('#userEditModal .btn-close');
if (closeBtn) {
    closeBtn.addEventListener('click', function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('userEditModal'));
        if (modal) modal.hide();
    });
} else {
    console.error('Close button not found!');
}
        }
        
        function initFileDropzone() {
            const dropzone = document.getElementById('fileDropzone');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                dropzone.classList.add('active');
            }
            
            function unhighlight() {
                dropzone.classList.remove('active');
            }
            
            dropzone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                document.getElementById('fileInput').files = files;
                handleFileUpload({ target: document.getElementById('fileInput') });
            }
        }
        
        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('loginError');
            
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                
                // Hide login form and show main application
                document.querySelector('.login-container').classList.add('hide');
                setTimeout(() => {
                    document.querySelector('.login-container').style.display = 'none';
                    document.querySelector('.main-container').classList.add('show');
                    
                    // Update user info in sidebar
                    document.getElementById('currentUserDisplay').textContent = user.username;
                    document.getElementById('sidebarUsername').textContent = user.name || user.username;
                    document.getElementById('sidebarUserRole').textContent = user.isAdmin ? 'مدیر سیستم' : 'کاربر عادی';
                    
                    // Show admin menu item if user is admin
                    if (user.isAdmin) {
                        document.getElementById('adminMenuItem').classList.remove('d-none');
                    } else {
                        document.getElementById('adminMenuItem').classList.add('d-none');
                    }
                    
                    // Load initial data
                    updateDashboard();
                    updateInventoryTable();
                    updatePartsList();
                    
                    // Check if user needs to change password
                    if (user.changePassword) {
                        const changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
                        changePasswordModal.show();
                    }
                }, 400);
            } else {
                errorElement.textContent = 'نام کاربری یا رمز عبور اشتباه است';
                errorElement.classList.remove('d-none');
            }
            if (user.isAdmin) {
    document.getElementById('adminMenuItem').classList.remove('d-none');
} else {
    document.getElementById('adminMenuItem').classList.add('d-none');
}
        }
        
        function handleLogout() {
            currentUser = null;
            document.querySelector('.main-container').classList.remove('show');
            setTimeout(() => {
                document.querySelector('.login-container').style.display = 'block';
                document.querySelector('.login-container').classList.remove('hide');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            }, 400);
        }
        
        function handleChangePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorElement = document.getElementById('passwordError');
            
            if (currentPassword !== currentUser.password) {
                errorElement.textContent = 'رمز عبور فعلی اشتباه است';
                errorElement.classList.remove('d-none');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                errorElement.textContent = 'رمز عبور جدید و تکرار آن مطابقت ندارند';
                errorElement.classList.remove('d-none');
                return;
            }
            
            if (newPassword.length < 4) {
                errorElement.textContent = 'رمز عبور باید حداقل 4 کاراکتر باشد';
                errorElement.classList.remove('d-none');
                return;
            }
            
            // Update password
            currentUser.password = newPassword;
            currentUser.changePassword = false;
            
            // Update in users array
            const userIndex = users.findIndex(u => u.username === currentUser.username);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
            }
            
            // Hide modal and show success message
            const changePasswordModal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
            changePasswordModal.hide();
            
            showToast('رمز عبور با موفقیت تغییر یافت', 'success');
        }
        
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('#dashboardSection, #partsSection, #inventorySection, #reportsSection, #usersSection').forEach(el => {
                el.classList.add('d-none');
            });
            
            // Show selected section
            document.getElementById(`${section}Section`).classList.remove('d-none');
            
            // Update specific section data if needed
            switch(section) {
                case 'dashboard':
                    updateDashboard();
                    break;
                case 'parts':
                    updatePartsList();
                    populatePartSelects();
                    break;
                case 'inventory':
                    updateInventoryTable();
                    break;
                case 'users':
                    updateUsersTable();
                    break;
                case 'reports':
                    generateWorksChart();
                    generateMonthlyStatsChart();
                    break;
            }
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('sidebar-collapsed');
            document.getElementById('mainContent').classList.toggle('main-content-expanded');
        }
        
        function generatePartCode() {
    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
    let result = '';
    
    for (let i = 0; i < 10; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    
    document.getElementById('partCode').value = result;
    
    // Generate Barcode (Code 128)
    const barcodeContainer = document.getElementById('qrCodeContainer');
    barcodeContainer.innerHTML = `<svg id="barcode"></svg>`;
    
    try {
        JsBarcode("#barcode", result, {
            format: "CODE128",
            lineColor: "#000",
            width: 2,
            height: 60,
            displayValue: true,
            fontSize: 14,
            margin: 10
        });
    } catch (e) {
        console.error("Barcode generation error:", e);
        barcodeContainer.innerHTML = "<p>خطا در تولید بارکد</p>";
    }
    document.getElementById('printBarcodeBtn').addEventListener('click', printBarcode);
    
    function printBarcode() {
        const partCode = document.getElementById('partCode').value;
        
        if (!partCode) {
            showToast('لطفاً ابتدا کد برد را تولید کنید', 'warning');
            return;
        }
        
        const printWindow = window.open('', '_blank');
        
        printWindow.document.write(`
            <!DOCTYPE html>
            <html dir="rtl">
            <head>
                <title>پرینت بارکد</title>
                <style>
                    body {
                        font-family: 'Vazir', sans-serif;
                        text-align: center;
                        margin: 0;
                        padding: 20px;
                    }
                    .barcode-container {
                        margin: 20px auto;
                        max-width: 100%;
                    }
                    .barcode-label {
                        margin-top: 10px;
                        font-size: 18px;
                        font-weight: bold;
                    }
                </style>
                <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"><\/script>
            </head>
            <body>
                <div class="printable-barcode">
                    
                    <div class="barcode-container">
                        <svg id="printBarcode"></svg>
                    </div>
                    
                    
                   
                </div>
                <script>
                    try {
                        JsBarcode("#printBarcode", "${partCode}", {
                            format: "CODE128",
                            lineColor: "#000",
                            width: 2,
                            height: 50,
                            displayValue: true,
                            fontSize: 14,
                            margin: 5
                        });
                        
                        window.onload = function() {
                            setTimeout(function() {
                                window.print();
                                window.close();
                            }, 200);
                        };
                    } catch(e) {
                        document.body.innerHTML = '<div style="color:red;padding:20px;">خطا در تولید بارکد</div>';
                    }
                <\/script>
            </body>
            </html>
        `);
        
        printWindow.document.close();
    }
}
        
        function scanQrCode() {
            // In a real app, this would use a QR scanner API
            showToast('این ویژگی در نسخه دمو قابل استفاده نیست. در نسخه کامل از API اسکنر QR استفاده می‌شود.', 'info');
        }
        
        function addUsedPart() {
            const partSelect = document.getElementById('usedPartSelect');
            const selectedPart = partSelect.options[partSelect.selectedIndex].text;
            const partId = partSelect.value;
            
            if (!partId) return;
            
            const usedPartsList = document.getElementById('usedPartsList');
            
            // Check if part is already added
            if (usedPartsList.querySelector(`[data-part-id="${partId}"]`)) {
                showToast('این قطعه قبلا اضافه شده است', 'warning');
                return;
            }
            
            // Create part item
            const partItem = document.createElement('div');
            partItem.className = 'part-item animate__animated animate__fadeIn';
            partItem.dataset.partId = partId;
            
            partItem.innerHTML = `
                <span>${selectedPart}</span>
                <div class="part-actions">
                    <button class="btn btn-sm btn-danger remove-used-part"><i class="bi bi-trash"></i></button>
                </div>
            `;
            
            usedPartsList.appendChild(partItem);
            
            // Add event listener to remove button
            partItem.querySelector('.remove-used-part').addEventListener('click', () => {
                partItem.classList.add('animate__fadeOut');
                setTimeout(() => {
                    partItem.remove();
                }, 400);
            });
        }
        
        function addReplacedPart() {
            const partSelect = document.getElementById('replacedPartSelect');
            const selectedPart = partSelect.options[partSelect.selectedIndex].text;
            const partId = partSelect.value;
            const faultDescription = document.getElementById('faultDescription').value;
            
            if (!partId) return;
            
            const replacedPartsList = document.getElementById('replacedPartsList');
            
            // Check if part is already added
            if (replacedPartsList.querySelector(`[data-part-id="${partId}"]`)) {
                showToast('این قطعه قبلا اضافه شده است', 'warning');
                return;
            }
            
            // Create part item
            const partItem = document.createElement('div');
            partItem.className = 'part-item animate__animated animate__fadeIn';
            partItem.dataset.partId = partId;
            
            partItem.innerHTML = `
                <div>
                    <div><strong>${selectedPart}</strong></div>
                    <div class="text-muted small">${faultDescription || 'شرح عیب وارد نشده'}</div>
                </div>
                <div class="part-actions">
                    <button class="btn btn-sm btn-danger remove-replaced-part"><i class="bi bi-trash"></i></button>
                </div>
            `;
            
            replacedPartsList.appendChild(partItem);
            
            // Add event listener to remove button
            partItem.querySelector('.remove-replaced-part').addEventListener('click', () => {
                partItem.classList.add('animate__fadeOut');
                setTimeout(() => {
                    partItem.remove();
                }, 400);
            });
            
            // Clear fault description
            document.getElementById('faultDescription').value = '';
        }
       
        function savePart() {
    const partName1 = document.getElementById('partName').value.trim();
    const partName = document.getElementById('partName').value;
    const partCode = document.getElementById('partCode').value;
    const productionDate = document.getElementById('productionDate').value;
    const workingVoltage = document.getElementById('workingVoltage').value;
    const currentConsumption = document.getElementById('currentConsumption').value;
    const faultDescription = document.getElementById('faultDescription').value;
    
    // اعتبارسنجی
    if (!partName || !partCode) {
        showToast('لطفا نام برد و کد برد را وارد کنید', 'danger');
        return;
    }
    if (!partName1 || partName1.length < 2) {
        showToast('لطفا نام معتبری برای برد وارد کنید (حداقل 2 کاراکتر)', 'danger');
        return;
    }
    // بررسی تکراری نبودن کد
    if (parts.some(p => p.code === partCode)) {
        showToast('کد برد تکراری است. لطفاً کد جدیدی تولید کنید', 'danger');
        return;
    }

    // ایجاد شیء جدید برای برد
    const newPart = {
        id: Date.now().toString(),
        name: partName,
        code: partCode,
        productionDate,
        workingVoltage: workingVoltage || null,
        currentConsumption: currentConsumption || null,
        faultDescription: faultDescription || null,
        usedParts: [],
        replacedParts: [],
        files: [],
        completed: false,
        createdBy: currentUser.username,
        completedBy: null,
        completionDate: null,
        createdAt: new Date().toISOString(),
        troubleshootingActions: '' // مقدار اولیه خالی
    };
    
    // افزودن به آرایه بردها
    parts.push(newPart);
    localStorage.setItem('parts', JSON.stringify(parts));
    
    // نمایش پیام موفقیت
    showToast('برد با موفقیت ثبت شد', 'success');
    
    // به‌روزرسانی رابط کاربری
    updateDashboard();
    updatePartsList();
    
    // ریست فرم
    
    resetPartForm();

}

// اطمینان از اتصال رویداد کلیک به دکمه ذخیره
document.getElementById('savePartBtn').addEventListener('click', savePart);

        // تابع resetPartForm با پارامتر اختیاری برای کنترل آزادسازی منابع
       
        function resetPartForm(keepFiles = false) {
    // 1. Reset form fields
    const fieldsToReset = {
        'partName': '',
        'partCode': '',
        'workingVoltage': '',
        'currentConsumption': '',
        'faultDescription': '',
        'productionDate': new Date().toLocaleDateString('fa-IR'),
        'troubleshootingActionsText': ''
    };

    Object.entries(fieldsToReset).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) element.value = value;
    });

    // 2. Reset parts lists
    ['usedPartsList', 'replacedPartsList'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.innerHTML = '';
    });

    // 3. Handle files
    const fileListContainer = document.getElementById('fileListContainer');
    if (fileListContainer) {
        if (!keepFiles) {
            // Free memory by revoking object URLs
            uploadedFiles.forEach(file => {
                try {
                    if (file.url) URL.revokeObjectURL(file.url);
                } catch (e) {
                    console.error('Error revoking file URL:', e);
                }
            });
            uploadedFiles = [];
            fileListContainer.innerHTML = '';
        } else {
            // Just clear the display but keep files in memory
            fileListContainer.innerHTML = '';
            uploadedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <a href="${file.url}" target="_blank" download="${file.name}" class="file-link">
                        <i class="bi ${getFileIcon(file.type)}"></i> ${file.name}
                    </a>
                    <button class="btn btn-sm btn-danger remove-file" data-file-index="${index}">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                fileListContainer.appendChild(fileItem);
            });
        }
    }

    // 4. Reset QR code
    const qrCodeContainer = document.getElementById('qrCodeContainer');
    if (qrCodeContainer) qrCodeContainer.innerHTML = '';

    // 5. Reset any additional state
    currentPartId = null;

    // 6. Set focus to the first field
    const firstField = document.getElementById('partName');
    if (firstField) firstField.focus();
}


function getFileIcon(fileType) {
    if (fileType.startsWith('image/')) return 'bi-file-image';
    if (fileType.includes('pdf')) return 'bi-file-pdf';
    if (fileType.includes('word')) return 'bi-file-word';
    if (fileType.includes('excel')) return 'bi-file-excel';
    return 'bi-file-earmark';
}


        function markAsComplete(partId) {
    const part = parts.find(p => p.id === partId);
    if (!part) return;
    
    // ذخیره آخرین تغییرات در متن اقدامات
    const actionsText = document.getElementById('troubleshootingActionsText');
    if (actionsText) {
        part.troubleshootingActions = actionsText.value;
    } 
   
        part.completed = true;
        part.completedBy = currentUser.username;
        part.completionDate = new Date().toLocaleDateString('fa-IR');
        const partIndex = parts.findIndex(p => p.id === partId);
    if (partIndex !== -1) {
        parts[partIndex] = part;
        localStorage.setItem('parts', JSON.stringify(parts));
    }
        
        showToast('پایان کار برای این برد ثبت شد', 'success');
        updateDashboard();
        updatePartsList();
    }

        
        function searchPart() {
            const searchTerm = document.getElementById('searchPartInput').value.toLowerCase();
            
            if (!searchTerm) {
                showToast('لطفا نام یا کد برد را وارد کنید', 'warning');
                return;
            }
            
            const foundPart = parts.find(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.code.toLowerCase().includes(searchTerm)
            );
            
            if (foundPart) {
                displayPartDetails(foundPart);
            } else {
                showToast('برد مورد نظر یافت نشد', 'danger');
                document.getElementById('partDetailsContainer').classList.add('d-none');
            }
        }
        
        function searchParts() {
            const searchTerm = document.getElementById('partSearch').value.toLowerCase();
            const tableBody = document.getElementById('allPartsTable');
            
            tableBody.innerHTML = '';
            
            const filteredParts = parts.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.code.toLowerCase().includes(searchTerm)
            );
            
            if (filteredParts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">هیچ بردی یافت نشد</td></tr>';
                return;
            }
            
            filteredParts.forEach(part => {
                const row = document.createElement('tr');
                row.className = 'animate__animated animate__fadeIn';
                
                row.innerHTML = `
                    <td>${part.code}</td>
                    <td>${part.name}</td>
                    <td>${part.createdBy}</td>
                    <td>
                        <span class="status-badge ${part.completed ? 'badge-completed' : 'badge-ongoing'}">
                            ${part.completed ? 'تعمیر شده' : 'در حال انجام'}
                        </span>
                    </td>
                    <td>
                        <td>
    <button class="btn btn-sm btn-primary view-part-list" data-part-id="${part.id}">
        <i class="bi bi-eye"></i> مشاهده
    </button>
    ${!part.completed ? `
    <button class="btn btn-sm btn-success complete-part-list" data-part-id="${part.id}">
        <i class="bi bi-check-circle"></i> ثبت پایان
    </button>
    ` : ''}
</td>
                `;
                
                tableBody.appendChild(row);
                
                // Add event listener to view button
                row.querySelector('.view-part-btn').addEventListener('click', () => {
                    showPartDetailsModal(part);
                });
            });
        }
        
        function showPartDetailsModal(part) {
            document.getElementById('partDetailsModal').dataset.partId = part.id;
            const modalContent = document.getElementById('partDetailsContent');
            modalContent.innerHTML = '';
            
            const createDetailRow = (label, value) => `
                <div class="detail-row">
                    <div class="detail-label">${label}:</div>
                    <div class="detail-value">${value || 'ثبت نشده'}</div>
                </div>
            `;

            let html = `
            
            <div class="modal-body">
                <div class="part-details">
                    <h5>جزئیات برد</h5>
                    ${createDetailRow('نام برد', part.name)}
                    ${createDetailRow('کد برد', part.code)}
                    ${createDetailRow('تاریخ تولید', part.productionDate)}
                    ${createDetailRow('ولتاژ کاری', part.workingVoltage)}
                    ${createDetailRow('جریان مصرفی', part.currentConsumption)}
                    ${createDetailRow('شرح عیب', part.faultDescription)}
                    <div class="detail-row">
                        <div class="detail-label">وضعیت:</div>
                        <div class="detail-value">
                            <span class="status-badge ${part.completed ? 'badge-completed' : 'badge-ongoing'}">
                                ${part.completed ? 'تعمیر شده' : 'در حال انجام'}
                            </span>
                        </div>
                    </div>
                    ${createDetailRow('ثبت شده توسط', part.createdBy)}
                    ${part.completed ? createDetailRow('تکمیل شده توسط', part.completedBy) : ''}
                    ${part.completed ? createDetailRow('تاریخ تکمیل', part.completionDate) : ''}
                </div>
            `;

            // Add used parts section with search and add functionality
            html += `
                <div class="card mb-3 mt-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>قطعات بکار رفته</span>
                        ${part.completed ? '' : `
                        <button class="btn btn-sm btn-primary" id="addUsedPartBtnModal">
                            <i class="bi bi-plus"></i> افزودن قطعه
                        </button>
                        `}
                    </div>
                    <div class="card-body">
                        <div class="search-box mb-3" id="usedPartSearchContainer" style="${part.completed ? 'display:none;' : ''}">
                            <i class="bi bi-search"></i>
                            <input type="text" class="form-control" id="usedPartSearchInput" placeholder="جستجوی قطعه...">
                            <div class="search-results mt-2 d-none" id="usedPartSearchResults"></div>
                        </div>
                        <div id="detailUsedPartsList">
                            ${part.usedParts.length === 0 ? 
                                '<div class="text-muted">قطعه ای ثبت نشده است</div>' : 
                                part.usedParts.map(usedPart => `
                                    <div class="part-item d-flex justify-content-between align-items-center mb-2">
                                        <span>${usedPart.name}</span>
                                        ${part.completed ? '' : `
                                        <button class="btn btn-sm btn-danger remove-used-part" data-part-id="${usedPart.id}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        `}
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `;

            // Add replaced parts section with search, add and quantity functionality
            html += `
    <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>قطعات تعویض شده</span>
            ${part.completed ? '' : `
            <button class="btn btn-sm btn-primary" id="addReplacedPartBtnModal">
                <i class="bi bi-plus"></i> افزودن قطعه
            </button>
            `}
        </div>
        <div class="card-body">
            <div class="search-box mb-3" id="replacedPartSearchContainer" style="${part.completed ? 'display:none;' : ''}">
                <i class="bi bi-search"></i>
                <input type="text" class="form-control" id="replacedPartSearchInput" placeholder="جستجوی قطعه...">
                <div class="search-results mt-2 d-none" id="replacedPartSearchResults"></div>
            </div>
            <div id="detailReplacedPartsList">
                ${part.replacedParts.length === 0 ? 
                    '<div class="text-muted">قطعه ای ثبت نشده است</div>' : 
                    part.replacedParts.map(replacedPart => `
                        <div class="part-item d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <div><strong>${replacedPart.name}</strong></div>
                                <div class="text-white">تعداد: ${replacedPart.quantity || 1}</div>
                            </div>
                            ${part.completed ? '' : `
                            <button class="btn btn-sm btn-danger remove-replaced-part" data-part-id="${replacedPart.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                            `}
                        </div>
                    `).join('')
                }
            </div>
        </div>
    </div>
`;
            // Add files section
            html += `
                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>فایل های مرتبط</span>
                        ${part.completed ? '' : `
                        <button class="btn btn-sm btn-primary" id="addFileBtnModal">
                            <i class="bi bi-plus"></i> افزودن فایل
                        </button>
                        `}
                    </div>
                    <div class="card-body">
                        <input type="file" id="fileInputModal" class="d-none" multiple>
                        <div class="file-list" id="detailFilesList">
                            ${part.files.length === 0 ? 
                                '<div class="text-muted">فایلی ثبت نشده است</div>' : 
                                part.files.map((file, index) => `
                                    <div class="file-item d-flex justify-content-between align-items-center mb-2">
                                        <a href="${file.url}" download="${file.name}" class="text-primary text-decoration-none">
                                            <i class="bi bi-file-earmark"></i> ${file.name}
                                        </a>
                                        ${part.completed ? '' : `
                                        <button class="btn btn-sm btn-danger remove-file" data-file-index="${index}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        `}
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
// Add editable troubleshooting actions section
html += `
    <div class="card mb-3">
        <div class="card-header">اقدامات انجام شده جهت رفع عیب</div>
        <div class="card-body">
           <textarea class="form-control" id="troubleshootingActionsText" rows="5">${part.troubleshootingActions || ''}</textarea>
        </div>
    </div>
`;
// بعد از نمایش modal
const textarea = document.getElementById('troubleshootingActionsText');
if (textarea) {
    textarea.addEventListener('input', function() {
        part.troubleshootingActions = this.value;
        localStorage.setItem('parts', JSON.stringify(parts));
    });
}
            // Add complete button if not completed
            if (!part.completed) {
                html += `
                    <div class="d-grid mt-3">
                        <button class="btn btn-success" id="completePartBtnModal">
                            <i class="bi bi-check-circle"></i> ثبت پایان کار
                        </button>
                    </div>
                `;
            }

            modalContent.innerHTML = html;

            // Event listeners for modal
            if (!part.completed) {
                // Add used part functionality
                document.getElementById('addUsedPartBtnModal').addEventListener('click', () => {
                    document.getElementById('usedPartSearchContainer').style.display = 'block';
                });

                document.getElementById('usedPartSearchInput').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const resultsContainer = document.getElementById('usedPartSearchResults');
                    
                    if (searchTerm.length < 2) {
                        resultsContainer.classList.add('d-none');
                        return;
                    }
                    
                    const filteredItems = inventory.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) &&
                        !part.usedParts.some(used => used.id === item.id)
                    );
                    
                    if (filteredItems.length === 0) {
                        resultsContainer.innerHTML = '<div class="text-muted">هیچ قطعه ای یافت نشد</div>';
                        resultsContainer.classList.remove('d-none');
                        return;
                    }
                    
                    resultsContainer.innerHTML = filteredItems.map(item => `
                        <div class="search-result-item p-2 border-bottom" data-id="${item.id}" data-name="${item.name}">
                            ${item.name} (موجودی: ${item.quantity})
                        </div>
                    `).join('');
                    
                    resultsContainer.classList.remove('d-none');
                    
                    // Add click event to search results
                    document.querySelectorAll('#usedPartSearchResults .search-result-item').forEach(item => {
                        item.addEventListener('click', function() {
                            const partId = this.dataset.id;
                            const partName = this.dataset.name;
                            
                            // Add to used parts list
                            part.usedParts.push({ id: partId, name: partName });
                            
                            // Update display
                            const usedPartsList = document.getElementById('detailUsedPartsList');
                            const partItem = document.createElement('div');
                            partItem.className = 'part-item d-flex justify-content-between align-items-center mb-2';
                            partItem.innerHTML = `
                                <span>${partName}</span>
                                <button class="btn btn-sm btn-danger remove-used-part" data-part-id="${partId}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            `;
                            usedPartsList.appendChild(partItem);
                            
                            // Add remove event
                            partItem.querySelector('.remove-used-part').addEventListener('click', function() {
                                part.usedParts = part.usedParts.filter(p => p.id !== partId);
                                partItem.remove();
                            });
                            
                            // Clear search
                            document.getElementById('usedPartSearchInput').value = '';
                            resultsContainer.classList.add('d-none');
                        });
                    });
                });

                // Add replaced part functionality
                document.getElementById('addReplacedPartBtnModal').addEventListener('click', () => {
                    document.getElementById('replacedPartSearchContainer').style.display = 'block';
                });

                document.getElementById('replacedPartSearchInput').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const resultsContainer = document.getElementById('replacedPartSearchResults');
                    
                    if (searchTerm.length < 2) {
                        resultsContainer.classList.add('d-none');
                        return;
                    }
                    
                    const filteredItems = inventory.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) &&
                        !part.replacedParts.some(replaced => replaced.id === item.id)
                    );
                    
                    if (filteredItems.length === 0) {
                        resultsContainer.innerHTML = '<div class="text-muted">هیچ قطعه ای یافت نشد</div>';
                        resultsContainer.classList.remove('d-none');
                        return;
                    }
                    
                    resultsContainer.innerHTML = filteredItems.map(item => `
                        <div class="search-result-item p-2 border-bottom" data-id="${item.id}" data-name="${item.name}" data-quantity="${item.quantity}">
                            ${item.name} (موجودی: ${item.quantity})
                            <div class="mt-2">
                                <label class="small">تعداد:</label>
                                <input type="number" class="form-control form-control-sm quantity-input" min="1" max="${item.quantity}" value="1">
                            </div>
                            <button class="btn btn-sm btn-primary w-100 mt-2 add-replaced-part-btn">افزودن</button>
                        </div>
                    `).join('');
                    
                    resultsContainer.classList.remove('d-none');
                    
                    // Add click event to add buttons
                    document.querySelectorAll('#replacedPartSearchResults .add-replaced-part-btn').forEach(btn => {
                        btn.addEventListener('click', function() {
                            const item = this.closest('.search-result-item');
                            const partId = item.dataset.id;
                            const partName = item.dataset.name;
                            const quantity = parseInt(item.querySelector('.quantity-input').value);
                            
                            if (quantity < 1) {
                                showToast('تعداد باید حداقل 1 باشد', 'warning');
                                return;
                            }
                            
                            // Check inventory
                            const inventoryItem = inventory.find(i => i.id === partId);
                            if (inventoryItem.quantity < quantity) {
                                showToast(`موجودی کافی نیست (موجودی: ${inventoryItem.quantity})`, 'danger');
                                return;
                            }
                            
                            // Add to replaced parts list
                            part.replacedParts.push({ id: partId, name: partName, quantity });
                            
                            // Update display
                            const replacedPartsList = document.getElementById('detailReplacedPartsList');
                            const partItem = document.createElement('div');
                            partItem.className = 'part-item d-flex justify-content-between align-items-center mb-3';
                            partItem.innerHTML = `
                                <div>
                                    <div><strong>${partName}</strong></div>
                                    <div class="text-muted small">تعداد: ${quantity}</div>
                                </div>
                                <button class="btn btn-sm btn-danger remove-replaced-part" data-part-id="${partId}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            `;
                            replacedPartsList.appendChild(partItem);
                            
                            // Add remove event
                            partItem.querySelector('.remove-replaced-part').addEventListener('click', function() {
                                part.replacedParts = part.replacedParts.filter(p => p.id !== partId);
                                partItem.remove();
                            });
                            
                            // Clear search
                            document.getElementById('replacedPartSearchInput').value = '';
                            resultsContainer.classList.add('d-none');
                        });
                    });
                });

                // Add file functionality
                document.getElementById('addFileBtnModal').addEventListener('click', () => {
                    document.getElementById('fileInputModal').click();
                });

                document.getElementById('fileInputModal').addEventListener('change', function(e) {
                    const files = e.target.files;
                    if (files.length === 0) return;
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        
                        // Check for duplicate files
                        const isDuplicate = part.files.some(f => f.name === file.name && f.size === file.size);
                        if (isDuplicate) {
                            showToast(`فایل "${file.name}" قبلاً اضافه شده است`, 'warning');
                            continue;
                        }
                        
                        const fileUrl = URL.createObjectURL(file);
                        part.files.push({
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            url: fileUrl
                        });
                        
                        // Update display
                        const filesList = document.getElementById('detailFilesList');
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item d-flex justify-content-between align-items-center mb-2';
                        fileItem.innerHTML = `
                            <a href="${fileUrl}" download="${file.name}" class="text-primary text-decoration-none">
                                <i class="bi bi-file-earmark"></i> ${file.name}
                            </a>
                            <button class="btn btn-sm btn-danger remove-file" data-file-index="${part.files.length - 1}">
                                <i class="bi bi-trash"></i>
                            </button>
                        `;
                        filesList.appendChild(fileItem);
                        
                        // Add remove event
                        fileItem.querySelector('.remove-file').addEventListener('click', function() {
                            const index = parseInt(this.dataset.fileIndex);
                            URL.revokeObjectURL(part.files[index].url);
                            part.files.splice(index, 1);
                            fileItem.remove();
                        });
                    }
                    
                    // Reset file input
                    e.target.value = '';
                });

                // Complete part button
                document.getElementById('completePartBtnModal').addEventListener('click', function() {
                    // Update inventory for replaced parts
                    part.replacedParts.forEach(replacedPart => {
                        const inventoryItem = inventory.find(item => item.id === replacedPart.id);
                        if (inventoryItem) {
                            inventoryItem.quantity -= replacedPart.quantity;
                            
                            if (inventoryItem.quantity < 0) {
                                inventoryItem.quantity = 0;
                            }
                        }
                    });
                    
                    // Mark as completed
                    part.completed = true;
                    part.completedBy = currentUser.username;
                    part.completionDate = new Date().toLocaleDateString('fa-IR');
                    
                    // Save changes
                    localStorage.setItem('parts', JSON.stringify(parts));
                    localStorage.setItem('inventory', JSON.stringify(inventory));
                    
                    // Close modal
                    partDetailsModal.hide();
                    
                    // Update UI
                    updateDashboard();
                    updatePartsList();
                    updateInventoryTable();
                    
                    showToast('پایان کار برای این برد ثبت شد', 'success');
                });
            }

            // Delete part button (only for admin and not completed parts)
            if (document.getElementById('deletePartBtn')) {
                document.getElementById('deletePartBtn').addEventListener('click', function() {
                    if (confirm('آیا از حذف این برد مطمئن هستید؟ این عمل غیرقابل بازگشت است.')) {
                        // Free file URLs
                        if (part.files) {
                            part.files.forEach(file => {
                                try {
                                    URL.revokeObjectURL(file.url);
                                } catch (e) {
                                    console.error('Error revoking file URL:', e);
                                }
                            });
                        }
                        
                        // Remove part
                        parts = parts.filter(p => p.id !== part.id);
                        localStorage.setItem('parts', JSON.stringify(parts));
                        
                        // Close modal
                        partDetailsModal.hide();
                        
                        // Update UI
                        updateDashboard();
                        updatePartsList();
                        
                        showToast('برد با موفقیت حذف شد', 'success');
                    }
                });
            }

            // Add remove events for existing used parts
            document.querySelectorAll('.remove-used-part').forEach(btn => {
                btn.addEventListener('click', function() {
                    const partId = this.dataset.partId;
                    part.usedParts = part.usedParts.filter(p => p.id !== partId);
                    this.closest('.part-item').remove();
                });
            });

            // Add remove events for existing replaced parts
            document.querySelectorAll('.remove-replaced-part').forEach(btn => {
                btn.addEventListener('click', function() {
                    const partId = this.dataset.partId;
                    part.replacedParts = part.replacedParts.filter(p => p.id !== partId);
                    this.closest('.part-item').remove();
                });
            });

            // Add remove events for existing files
            document.querySelectorAll('.remove-file').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.dataset.fileIndex);
                    URL.revokeObjectURL(part.files[index].url);
                    part.files.splice(index, 1);
                    this.closest('.file-item').remove();
                });
            });

            partDetailsModal.show();
            setupTroubleshootingTextAutoSave(part);
        }
   
        function previewFile(file) {
            const isImage = file.type.startsWith('image/');
            const previewImage = document.getElementById('filePreviewImage');
            const previewContent = document.getElementById('filePreviewContent');
            const downloadLink = document.getElementById('fileDownloadLink');
            
            if (isImage) {
                previewImage.src = file.url;
                previewImage.style.display = 'block';
                previewContent.innerHTML = `<h5>${file.name}</h5><p>حجم: ${formatFileSize(file.size)}</p>`;
            } else {
                previewImage.style.display = 'none';
                previewContent.innerHTML = `
                    <div class="d-flex flex-column align-items-center">
                        <i class="bi bi-file-earmark" style="font-size: 5rem;"></i>
                        <h5 class="mt-3">${file.name}</h5>
                        <p>حجم: ${formatFileSize(file.size)}</p>
                    </div>
                `;
            }
            
            downloadLink.href = file.url;
            downloadLink.download = file.name;
            
            filePreviewModal.show();
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 بایت';
            const k = 1024;
            const sizes = ['بایت', 'کیلوبایت', 'مگابایت', 'گیگابایت'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function displayPartDetails(part) {
            const container = document.getElementById('partDetailsContainer');
            container.innerHTML = '';
            container.classList.remove('d-none');
            
            let html = `
                <div class="part-details">
                    <h5>جزئیات برد</h5>
                    <div class="detail-row">
                        <div class="detail-label">نام برد:</div>
                        <div class="detail-value">${part.name}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">کد برد:</div>
                        <div class="detail-value">${part.code}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">تاریخ تولید:</div>
                        <div class="detail-value">${part.productionDate}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ولتاژ کاری:</div>
                        <div class="detail-value">${part.workingVoltage || 'ثبت نشده'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">جریان مصرفی:</div>
                        <div class="detail-value">${part.currentConsumption || 'ثبت نشده'}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">وضعیت:</div>
                        <div class="detail-value">
                            <span class="status-badge ${part.completed ? 'badge-completed' : 'badge-ongoing'}">
                                ${part.completed ? 'تعمیر شده' : 'در حال انجام'}
                            </span>
                        </div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">ثبت شده توسط:</div>
                        <div class="detail-value">${part.createdBy}</div>
                    </div>
            `;
            
            if (part.completed) {
                html += `
                    <div class="detail-row">
                        <div class="detail-label">تکمیل شده توسط:</div>
                        <div class="detail-value">${part.completedBy}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">تاریخ تکمیل:</div>
                        <div class="detail-value">${part.completionDate}</div>
                    </div>
                `;
            }
            
            html += `</div>`;
            
            // Add used parts section
            html += `
                <div class="card mb-3 mt-4">
                    <div class="card-header">قطعات بکار رفته</div>
                    <div class="card-body" id="detailUsedPartsList">
            `;
            
            if (part.usedParts.length === 0) {
                html += '<div class="text-muted">قطعه ای ثبت نشده است</div>';
            } else {
                part.usedParts.forEach(usedPart => {
                    html += `
                        <div class="mb-2">
                            <i class="bi bi-check-circle text-success"></i> ${usedPart.name}
                        </div>
                    `;
                });
            }
            
            html += `</div></div>`;
            
            // Add replaced parts section
            html += `
                <div class="card mb-3">
                    <div class="card-header">قطعات تعویض شده</div>
                    <div class="card-body" id="detailReplacedPartsList">
            `;
            
            if (part.replacedParts.length === 0) {
                html += '<div class="text-muted">قطعه ای ثبت نشده است</div>';
            } else {
                part.replacedParts.forEach(replacedPart => {
                    html += `
                        <div class="mb-3">
                            <div><i class="bi bi-arrow-repeat text-warning"></i> <strong>${replacedPart.name}</strong></div>
                            <div class="text-muted small mt-1">${replacedPart.faultDescription || 'شرح عیب وارد نشده'}</div>
                        </div>
                    `;
                });
            }
            
            html += `</div></div>`;
            
            // Add files section
            html += `
                <div class="card">
                    <div class="card-header">فایل های مرتبط</div>
                    <div class="card-body" id="detailFilesList">
            `;
            
            if (part.files.length === 0) {
                html += '<div class="text-muted">فایلی ثبت نشده است</div>';
            } else {
                html += '<div class="file-preview-container">';
                part.files.forEach((file, index) => {
                    const isImage = file.type.startsWith('image/');
                    
                    html += `
                        <div class="file-preview-item">
                            ${isImage ? 
                                `<img src="${file.url}" alt="${file.name}" class="file-preview-img" data-file-index="${index}">` : 
                                `<div class="file-icon"><i class="bi bi-file-earmark"></i></div>`
                            }
                            <div class="file-name">${file.name}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += `</div></div>`;
            
            container.innerHTML = html;
            
            // Add event listeners to file preview items
            document.querySelectorAll('.file-preview-img').forEach(img => {
                img.addEventListener('click', (e) => {
                    const index = e.target.dataset.fileIndex;
                    previewFile(part.files[index]);
                });
            });
        }

       function handleFileUpload(e) {
    const files = e.target.files;
    const fileListContainer = document.getElementById('fileListContainer');
    
    if (files.length === 0) return;

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        
        // بررسی وجود فایل تکراری
        const isDuplicate = uploadedFiles.some(f => f.name === file.name && f.size === file.size);
        if (isDuplicate) {
            showToast(`فایل "${file.name}" قبلاً اضافه شده است`, 'warning');
            continue;
        }

        const fileUrl = URL.createObjectURL(file);
        
        uploadedFiles.push({
            name: file.name,
            type: file.type,
            size: file.size,
            url: fileUrl,
            blobUrl: fileUrl // ذخیره URL برای استفاده بعدی
        });

        const fileItem = document.createElement('div');
        fileItem.className = 'file-item animate__animated animate__fadeIn';
        
        fileItem.innerHTML = `
            <a href="${fileUrl}" target="_blank" download="${file.name}" class="file-link">
                <i class="bi ${getFileIcon(file.type)}"></i> ${file.name}
            </a>
            <button class="btn btn-sm btn-danger remove-file" data-file-index="${uploadedFiles.length - 1}">
                <i class="bi bi-trash"></i>
            </button>
        `;

        fileListContainer.appendChild(fileItem);

        // افزودن event listener برای دکمه حذف
        fileItem.querySelector('.remove-file').addEventListener('click', (e) => {
            e.stopPropagation();
            const index = parseInt(e.currentTarget.dataset.fileIndex);
            URL.revokeObjectURL(uploadedFiles[index].blobUrl);
            uploadedFiles.splice(index, 1);
            fileItem.remove();
            // به‌روزرسانی اندیس‌ها برای فایل‌های باقی‌مانده
            document.querySelectorAll('.remove-file').forEach((btn, idx) => {
                btn.dataset.fileIndex = idx;
            });
        });
    }
    // ریست کردن input file برای امکان انتخاب مجدد همان فایل
    e.target.value = '';
}

// تابع کمکی برای دریافت آیکون مناسب براساس نوع فایل
        function getFileIcon(fileType) {
    if (fileType.startsWith('image/')) return 'bi-file-image';
    if (fileType.includes('word')) return 'bi-file-word';
    if (fileType.includes('excel')) return 'bi-file-excel';
    return 'bi-file-earmark';
} 
       
        function saveInventoryItem() {
            const partName = document.getElementById('inventoryPartName').value;
            const quantity = parseInt(document.getElementById('inventoryQuantity').value);
            
            if (!partName || isNaN(quantity) || quantity < 0) {
                showToast('لطفا نام قطعه و تعداد را به درستی وارد کنید', 'danger');
                return;
            }
            
            // Check if item already exists
            const existingItemIndex = inventory.findIndex(item => item.name.toLowerCase() === partName.toLowerCase());
            
            if (existingItemIndex !== -1) {
                // Update existing item
                inventory[existingItemIndex].quantity = quantity;
            } else {
                // Add new item
                inventory.push({
                    id: Date.now().toString(),
                    name: partName,
                    quantity
                });
            }
            
            localStorage.setItem('inventory', JSON.stringify(inventory));
            
            // Clear form
            document.getElementById('inventoryPartName').value = '';
            document.getElementById('inventoryQuantity').value = '';
            
            // Update inventory table
            updateInventoryTable();
            
            // Show success message
            showToast('موجودی با موفقیت ثبت شد', 'success');
        }
        
        function updateInventoryForUsedParts(usedParts) {
            usedParts.forEach(usedPart => {
                const inventoryItem = inventory.find(item => item.name === usedPart.name);
                
                if (inventoryItem) {
                    inventoryItem.quantity -= 1;
                    
                    // Check if stock is low
                    if (inventoryItem.quantity < 3) {
                        showToast(`توجه: موجودی قطعه "${usedPart.name}" به ${inventoryItem.quantity} رسیده است`, 'warning');
                    }
                }
            });
            
            localStorage.setItem('inventory', JSON.stringify(inventory));
            updateInventoryTable();
        }
        
        function updateDashboard() {
            // Update counts
            document.getElementById('totalPartsCount').textContent = parts.length;
            document.getElementById('completedPartsCount').textContent = parts.filter(p => p.completed).length;
            document.getElementById('ongoingPartsCount').textContent = parts.filter(p => !p.completed).length;
            
            // Count low stock items (quantity < 3)
            const lowStockCount = inventory.filter(item => item.quantity < 3).length;
            document.getElementById('lowStockPartsCount').textContent = lowStockCount;
            
            // Update recent parts table
            const recentPartsTable = document.getElementById('recentPartsTable');
            recentPartsTable.innerHTML = '';
            
            // Get 5 most recent parts
            const recentParts = [...parts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
            
            if (recentParts.length === 0) {
                recentPartsTable.innerHTML = '<tr><td colspan="5" class="text-center">هیچ بردی ثبت نشده است</td></tr>';
                return;
            }
            
            recentParts.forEach(part => {
                const row = document.createElement('tr');
                row.className = 'animate__animated animate__fadeIn';
                
                row.innerHTML = `
                    <td>${part.code}</td>
                    <td>${part.name}</td>
                    <td>
                        <span class="status-badge ${part.completed ? 'badge-completed' : 'badge-ongoing'}">
                            ${part.completed ? 'تعمیر شده' : 'در حال انجام'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary view-part-dashboard" data-part-id="${part.id}">
                            <i class="bi bi-eye"></i> مشاهده
                        </button>
                    </td>
                `;
                
                recentPartsTable.appendChild(row);
                
                // Add event listener to view button
                row.querySelector('.view-part-dashboard').addEventListener('click', (e) => {
    const partId = e.target.closest('button').dataset.partId;
    const part = parts.find(p => p.id === partId);
    if (part) {
        showPartDetailsModal(part);
    }
});
            });
            
            // Update ongoing works table
            const ongoingWorksTable = document.getElementById('ongoingWorksTable');
    ongoingWorksTable.innerHTML = '';
    
    const ongoingWorks = parts.filter(p => !p.completed);
    
    if (ongoingWorks.length === 0) {
        ongoingWorksTable.innerHTML = '<tr><td colspan="4" class="text-center">هیچ کاری در حال انجام نیست</td></tr>';
        return;
    }
    
    ongoingWorks.forEach(part => {
        const row = document.createElement('tr');
        row.className = 'ongoing-work animate__animated animate__fadeIn';
        
        row.innerHTML = `
            <td>${part.code}</td>
            <td>${part.name}</td>
            <td>${part.createdBy}</td>
            <td>
                <button class="btn btn-sm btn-primary view-part-dashboard" data-part-id="${part.id}">
                    <i class="bi bi-eye"></i> مشاهده
                </button>
                <button class="btn btn-sm btn-success complete-from-dashboard" data-part-id="${part.id}">
                    <i class="bi bi-check-circle"></i> ثبت پایان
                </button>
            </td>
        `;
        
        ongoingWorksTable.appendChild(row);
        
        // Add event listener to view button
        row.querySelector('.view-part-dashboard').addEventListener('click', (e) => {
            const partId = e.target.closest('button').dataset.partId;
            const part = parts.find(p => p.id === partId);
            if (part) {
                showPartDetailsModal(part);
            }
        });
        
        // Add event listener to complete button
        row.querySelector('.complete-from-dashboard').addEventListener('click', (e) => {
            const partId = e.target.closest('button').dataset.partId;
            markAsComplete(partId);
        });
    });
        }
        


        function setupTroubleshootingTextAutoSave(part) {
    const textarea = document.getElementById('troubleshootingActionsText');
    if (!textarea) return;
    
    textarea.addEventListener('input', function() {
        part.troubleshootingActions = this.value;
        
        // پیدا کردن ایندکس part در آرایه parts
        const partIndex = parts.findIndex(p => p.id === part.id);
        if (partIndex !== -1) {
            parts[partIndex] = part;
            localStorage.setItem('parts', JSON.stringify(parts));
        }
    });
}
    //mohammad//////////////////////////
      // توابع جدید برای گزارش‌گیری اکسل
async function exportToExcel(data, fileName, sheetName = 'Sheet1') {
    try {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet(sheetName);
        
        // اضافه کردن هدرها
        const headers = Object.keys(data[0]);
        worksheet.addRow(headers);
        
        // اضافه کردن داده‌ها
        data.forEach(item => {
            const row = [];
            headers.forEach(header => {
                row.push(item[header]);
            });
            worksheet.addRow(row);
        });
        
        // ایجاد فایل و دانلود
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${fileName}_${new Date().toLocaleDateString('fa-IR')}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('خطا در تولید فایل اکسل:', error);
        showToast('خطا در تولید فایل اکسل', 'danger');
    }
}

// تابع کمکی برای تنظیمات مشترک ورق‌های اکسل
function setupWorksheetCommonStyles(worksheet) {
    // راست به چپ کردن ورق
    worksheet.views = [{ rightToLeft: true }];
    
    // تنظیم border برای تمام سلول‌ها
    worksheet.eachRow({ includeEmpty: true }, function(row, rowNumber) {
        row.eachCell({ includeEmpty: true }, function(cell) {
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };
            cell.alignment = { vertical: 'middle', horizontal: 'center' };
            
            // فقط سطر اول (هدر) را بولد می‌کنیم
            cell.font = rowNumber === 1 ? { bold: true } : { bold: false };
        });
    });
    
    // تنظیم عرض ستون‌ها بر اساس محتوا
    worksheet.columns.forEach(column => {
        let maxLength = 0;
        column.eachCell({ includeEmpty: true }, cell => {
            const columnLength = cell.value ? cell.value.toString().length : 0;
            if (columnLength > maxLength) {
                maxLength = columnLength;
            }
        });
        column.width = maxLength < 10 ? 10 : maxLength + 2;
    });
}

// تابع کمکی برای آماده‌سازی داده‌های بردها
function preparePartsData(parts) {
    return parts.map((part, index) => ({
        'ردیف': index + 1,
        'کد برد': part.code,
        'نام برد': part.name,
        'ولتاژ کاری': part.workingVoltage || '-',
        'جریان مصرفی': part.currentConsumption || '-',
        'تاریخ تولید': part.productionDate,
        'شرح عیب': part.faultDescription || '-',
        'قطعات بکار رفته': part.usedParts.map(p => p.name).join(', ') || '-',
        'قطعات تعویض شده': part.replacedParts.map(p => `${p.name} (${p.quantity || 1} عدد)`).join(', ') || '-',
        'وضعیت': part.completed ? 'تعمیر شده' : 'در حال انجام',
        'ثبت شده توسط': part.createdBy,
        'تاریخ ثبت': new Date(part.createdAt).toLocaleDateString('fa-IR'),
        'تکمیل شده توسط': part.completedBy || '-',
        'تاریخ تکمیل': part.completionDate || '-',
        'اقدامات انجام شده': part.troubleshootingActions || '-'
    }));
}

// تابع کمکی برای آماده‌سازی داده‌های انبار
function prepareInventoryData(inventoryItems) {
    return inventoryItems.map((item, index) => ({
        'ردیف': index + 1,
        'نام قطعه': item.name,
        'موجودی': item.quantity,
        'وضعیت': item.quantity < 3 ? 'موجودی کم' : 'کافی',
        'تاریخ آخرین تغییر': new Date().toLocaleDateString('fa-IR')
    }));
}

// تابع کمکی برای اعمال استایل به هدر و داده‌ها
function applyWorksheetStyles(worksheet, data) {
    // رنگ پس‌زمینه برای سطرها (خاکستری خیلی کمرنگ)
    worksheet.eachRow((row, rowNumber) => {
        if (rowNumber > 1) { // از سطر دوم به بعد
            row.eachCell({ includeEmpty: true }, cell => {
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFEEEEEE' }
                };
            });
        }
    });

    // استایل هدر
    const headerRow = worksheet.getRow(1);
    headerRow.eachCell(cell => {
        cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFDDDDDD' } // خاکستری تیره‌تر برای هدر
        };
        cell.font = { bold: true, size: 12 };
    });
}

// 1. گزارش کلی تمام بردها با شیت‌های جداگانه
async function exportAllPartsToExcel() {
    const completedParts = parts.filter(part => part.completed);
    const ongoingParts = parts.filter(part => !part.completed);
    
    try {
        const workbook = new ExcelJS.Workbook();
        
        // شیت بردهای تعمیر شده
        if (completedParts.length > 0) {
            const completedSheet = workbook.addWorksheet('تعمیر شده');
            const completedData = preparePartsData(completedParts);
            
            completedSheet.addRow(Object.keys(completedData[0]));
            completedData.forEach(row => {
                completedSheet.addRow(Object.values(row));
            });
            
            setupWorksheetCommonStyles(completedSheet);
            applyWorksheetStyles(completedSheet, completedData);
        }
        
        // شیت بردهای در حال انجام
        if (ongoingParts.length > 0) {
            const ongoingSheet = workbook.addWorksheet('در حال انجام');
            const ongoingData = preparePartsData(ongoingParts);
            
            ongoingSheet.addRow(Object.keys(ongoingData[0]));
            ongoingData.forEach(row => {
                ongoingSheet.addRow(Object.values(row));
            });
            
            setupWorksheetCommonStyles(ongoingSheet);
            applyWorksheetStyles(ongoingSheet, ongoingData);
        }
        
        // دانلود فایل
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `گزارش_کلی_بردها_${new Date().toLocaleDateString('fa-IR')}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('خطا در تولید فایل اکسل:', error);
        showToast('خطا در تولید فایل اکسل', 'danger');
    }
}

// 2. گزارش بردها بر اساس وضعیت (تعمیر شده/در حال انجام)
async function exportPartsByStatus(status) {
    const filteredParts = parts.filter(part => status === 'completed' ? part.completed : !part.completed);
    if (filteredParts.length === 0) {
        showToast(`هیچ برد ${status === 'completed' ? 'تعمیر شده' : 'در حال انجام'} یافت نشد`, 'warning');
        return;
    }
    
    try {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('گزارش');
        const data = preparePartsData(filteredParts);
        
        worksheet.addRow(Object.keys(data[0]));
        data.forEach(row => {
            worksheet.addRow(Object.values(row));
        });
        
        setupWorksheetCommonStyles(worksheet);
        applyWorksheetStyles(worksheet, data);
        
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `بردهای_${status === 'completed' ? 'تعمیر_شده' : 'در_حال_انجام'}_${new Date().toLocaleDateString('fa-IR')}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('خطا در تولید فایل اکسل:', error);
        showToast('خطا در تولید فایل اکسل', 'danger');
    }
}

// 3. گزارش ماهانه بردها
async function exportMonthlyPartsReport() {
    const month = parseInt(document.getElementById('reportMonth').value);
    const year = parseInt(document.getElementById('reportYear').value);
    const status = document.getElementById('reportStatusFilter').value;
    
    const filteredParts = parts.filter(part => {
        const partDate = new Date(part.createdAt);
        const partYear = partDate.getFullYear();
        const partMonth = partDate.getMonth() + 1;
        
        const yearMatch = partYear === year;
        const monthMatch = month ? partMonth === month : true;
        const statusMatch = status === 'all' ? true : 
                          (status === 'completed' ? part.completed : !part.completed);
        
        return yearMatch && monthMatch && statusMatch;
    });
    
    if (filteredParts.length === 0) {
        showToast('هیچ بردی با معیارهای انتخاب شده یافت نشد', 'warning');
        return;
    }
    
    try {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('گزارش');
        const data = preparePartsData(filteredParts);
        
        worksheet.addRow(Object.keys(data[0]));
        data.forEach(row => {
            worksheet.addRow(Object.values(row));
        });
        
        setupWorksheetCommonStyles(worksheet);
        applyWorksheetStyles(worksheet, data);
        
        const monthName = month ? [
            'فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور',
            'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'
        ][month - 1] : 'همه';
        
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `گزارش_${monthName}_${year}_${status === 'all' ? 'همه' : (status === 'completed' ? 'تعمیر_شده' : 'در_حال_انجام')}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('خطا در تولید فایل اکسل:', error);
        showToast('خطا در تولید فایل اکسل', 'danger');
    }
}

// 4. گزارش موجودی انبار
async function exportInventoryReport(onlyLowStock = false) {
    const inventoryItems = onlyLowStock ? 
        inventory.filter(item => item.quantity < 3) : 
        inventory;
    
    if (inventoryItems.length === 0) {
        showToast(onlyLowStock ? 'هیچ قطعه‌ای با موجودی کم یافت نشد' : 'هیچ قطعه‌ای در انبار ثبت نشده است', 'warning');
        return;
    }
    
    try {
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('گزارش انبار');
        const data = prepareInventoryData(inventoryItems);
        
        worksheet.addRow(Object.keys(data[0]));
        data.forEach(row => {
            worksheet.addRow(Object.values(row));
        });
        
        setupWorksheetCommonStyles(worksheet);
        applyWorksheetStyles(worksheet, data);
        
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = onlyLowStock ? 'موجودی_کم_انبار.xlsx' : 'گزارش_کامل_انبار.xlsx';
        a.click();
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error('خطا در تولید فایل اکسل:', error);
        showToast('خطا در تولید فایل اکسل', 'danger');
    }
}
   





    
    
    
    
    //////////////////////////////
    function continueWork(partId) {
    const part = parts.find(p => p.id === partId);
    if (!part) return;

    // Create modal for continuing work
    const modalContent = `
        <div class="modal fade" id="continueWorkModal" tabindex="-1" aria-labelledby="continueWorkModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="continueWorkModalLabel">ادامه کار روی برد ${part.name}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="continuePartName" class="form-label">نام برد</label>
                            <input type="text" class="form-control" id="continuePartName" value="${part.name}" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="continueWorkingVoltage" class="form-label">ولتاژ کاری (ولت)</label>
                                    <input type="number" class="form-control" id="continueWorkingVoltage" value="${part.workingVoltage || ''}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="continueCurrentConsumption" class="form-label">جریان مصرفی (آمپر)</label>
                                    <input type="number" step="0.01" class="form-control" id="continueCurrentConsumption" value="${part.currentConsumption || ''}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">کد برد</label>
                            <input type="text" class="form-control" id="continuePartCode" value="${part.code}" readonly>
                            <div id="continueQrCodeContainer" class="mt-2 text-center"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">لطفا نام قطعات بکار رفته را مشخص کنید</label>
                            <div class="input-group mb-2">
                                <select class="form-select" id="continueUsedPartSelect">
                                    <option value="">انتخاب قطعه...</option>
                                    ${inventory.map(item => `<option value="${item.id}">${item.name}</option>`).join('')}
                                </select>
                                <button class="btn btn-primary" type="button" id="continueAddUsedPartBtn">افزودن</button>
                            </div>
                            <div class="card">
                                <div class="card-body" id="continueUsedPartsList" style="max-height: 200px; overflow-y: auto;">
                                    ${part.usedParts.map(usedPart => `
                                        <div class="part-item" data-part-id="${usedPart.id}">
                                            <span>${usedPart.name}</span>
                                            <div class="part-actions">
                                                <button class="btn btn-sm btn-danger remove-used-part"><i class="bi bi-trash"></i></button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">لطفا نام قطعات تعویض شده را مشخص کنید</label>
                            <div class="input-group mb-2">
                                <select class="form-select" id="continueReplacedPartSelect">
                                    <option value="">انتخاب قطعه...</option>
                                    ${inventory.map(item => `<option value="${item.id}">${item.name}</option>`).join('')}
                                </select>
                                <button class="btn btn-primary" type="button" id="continueAddReplacedPartBtn">افزودن</button>
                            </div>
                            <div class="mb-2">
                                <label for="continueFaultDescription" class="form-label">شرح عیب</label>
                                <textarea class="form-control" id="continueFaultDescription" rows="2"></textarea>
                            </div>
                            <div class="card">
                                <div class="card-body" id="continueReplacedPartsList" style="max-height: 200px; overflow-y: auto;">
                                    ${part.replacedParts.map(replacedPart => `
                                        <div class="part-item" data-part-id="${replacedPart.id}">
                                            <div>
                                                <div><strong>${replacedPart.name}</strong></div>
                                                <div class="text-muted small">${replacedPart.faultDescription || 'شرح عیب وارد نشده'}</div>
                                            </div>
                                            <div class="part-actions">
                                                <button class="btn btn-sm btn-danger remove-replaced-part"><i class="bi bi-trash"></i></button>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">فایل های مرتبط</label>
                            <div class="file-dropzone" id="continueFileDropzone">
                                <i class="bi bi-cloud-arrow-up"></i>
                                <p>برای آپلود فایل های جدید اینجا کلیک کنید یا فایل ها را اینجا رها کنید</p>
                                <p class="text-muted small">حداکثر حجم فایل: نامحدود (همه فرمت‌ها پشتیبانی می‌شوند)</p>
                                <input type="file" id="continueFileInput" class="d-none" multiple>
                            </div>
                            <div class="file-preview-container" id="continueFilePreviewContainer">
                                ${part.files.map((file, index) => `
                                    <div class="file-preview-item">
                                        <button class="remove-file" data-file-index="${index}">
                                            <i class="bi bi-x"></i>
                                        </button>
                                        ${file.type.startsWith('image/') ? 
                                            `<img src="${file.url}" alt="${file.name}" class="file-preview-img" data-file-index="${index}">` : 
                                            `<div class="file-icon"><i class="bi bi-file-earmark"></i></div>`
                                        }
                                        <div class="file-name">${file.name}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                        <button type="button" class="btn btn-success" id="continueMarkAsCompleteBtn">
                            <i class="bi bi-check-circle"></i> ثبت پایان کار
                        </button>
                        <button type="button" class="btn btn-primary" id="continueSaveBtn">
                            <i class="bi bi-save"></i> ذخیره تغییرات
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalContent);
    
    // Initialize modal
    const continueModal = new bootstrap.Modal(document.getElementById('continueWorkModal'));
    continueModal.show();

    // Generate QR code
    if (part.code) {
        const barcodeContainer = document.getElementById('qrCodeContainer');
barcodeContainer.innerHTML = `<svg id="barcode"></svg>`;
JsBarcode("#barcode", part.code, {
    format: "CODE128",
    lineColor: "#000",
    width: 2,
    height: 60,
    displayValue: true,
    fontSize: 14,
    margin: 10
});
    }

    // Initialize file dropzone
    initContinueFileDropzone();

    // Store the original part data
    document.getElementById('continueWorkModal').dataset.partId = part.id;
    document.getElementById('continueWorkModal').dataset.originalData = JSON.stringify(part);

    // Add event listeners
    document.getElementById('continueAddUsedPartBtn').addEventListener('click', addContinueUsedPart);
    document.getElementById('continueAddReplacedPartBtn').addEventListener('click', addContinueReplacedPart);
    document.getElementById('continueSaveBtn').addEventListener('click', saveContinueChanges);
    document.getElementById('continueMarkAsCompleteBtn').addEventListener('click', markContinueAsComplete);

    // Add remove event listeners to existing parts
    document.querySelectorAll('#continueUsedPartsList .remove-used-part').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.part-item').remove();
        });
    });

    document.querySelectorAll('#continueReplacedPartsList .remove-replaced-part').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.part-item').remove();
        });
    });

    // Add preview event listeners to existing files
    document.querySelectorAll('#continueFilePreviewContainer .file-preview-img').forEach(img => {
        img.addEventListener('click', function() {
            const index = this.dataset.fileIndex;
            const file = part.files[index];
            previewFile(file);
        });
    });

    // Add remove event listeners to existing files
    document.querySelectorAll('#continueFilePreviewContainer .remove-file').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const index = parseInt(this.dataset.fileIndex);
            part.files.splice(index, 1);
            this.closest('.file-preview-item').remove();
        });
    });
}

        function initContinueFileDropzone() {
    const dropzone = document.getElementById('continueFileDropzone');
    const fileInput = document.getElementById('continueFileInput');
    const previewContainer = document.getElementById('continueFilePreviewContainer');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropzone.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropzone.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
        dropzone.classList.add('active');
    }
    
    function unhighlight() {
        dropzone.classList.remove('active');
    }
    
    dropzone.addEventListener('drop', handleDrop, false);
    dropzone.addEventListener('click', () => fileInput.click());
    
    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        fileInput.files = files;
        handleContinueFileUpload({ target: fileInput });
    }
    
    fileInput.addEventListener('change', handleContinueFileUpload);
    
     function handleContinueFileUpload(e) {
        const files = e.target.files;
        const partId = document.getElementById('continueWorkModal').dataset.partId;
        const part = parts.find(p => p.id === partId);
        
        if (!part) return;
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileUrl = URL.createObjectURL(file);
            
            part.files.push({
                name: file.name,
                type: file.type,
                size: file.size,
                url: fileUrl
            });
            
            const isImage = file.type.startsWith('image/');
            
            const fileItem = document.createElement('div');
            fileItem.className = 'file-preview-item animate__animated animate__fadeIn';
            
            fileItem.innerHTML = `
                <button class="remove-file" data-file-index="${part.files.length - 1}">
                    <i class="bi bi-x"></i>
                </button>
                ${isImage ? 
                    `<img src="${fileUrl}" alt="${file.name}" class="file-preview-img" data-file-index="${part.files.length - 1}">` : 
                    `<div class="file-icon"><i class="bi bi-file-earmark"></i></div>`
                }
                <div class="file-name">${file.name}</div>
            `;
            
            previewContainer.appendChild(fileItem);
            
            // Add event listener to remove button
            fileItem.querySelector('.remove-file').addEventListener('click', (e) => {
                e.stopPropagation();
                const index = parseInt(e.currentTarget.dataset.fileIndex);
                part.files.splice(index, 1);
                fileItem.remove();
            });
            
            // Add event listener to preview image
            if (isImage) {
                fileItem.querySelector('.file-preview-img').addEventListener('click', (e) => {
                    const index = e.target.dataset.fileIndex;
                    previewFile(part.files[index]);
                });
            }
        }
    }
}

        function addContinueUsedPart() {
    const partSelect = document.getElementById('continueUsedPartSelect');
    const selectedPart = partSelect.options[partSelect.selectedIndex].text;
    const partId = partSelect.value;
    
    if (!partId) return;
    
    const usedPartsList = document.getElementById('continueUsedPartsList');
    
    // Check if part is already added
    if (usedPartsList.querySelector(`[data-part-id="${partId}"]`)) {
        showToast('این قطعه قبلا اضافه شده است', 'warning');
        return;
    }
    
    // Create part item
    const partItem = document.createElement('div');
    partItem.className = 'part-item animate__animated animate__fadeIn';
    partItem.dataset.partId = partId;
    
    partItem.innerHTML = `
        <span>${selectedPart}</span>
        <div class="part-actions">
            <button class="btn btn-sm btn-danger remove-used-part"><i class="bi bi-trash"></i></button>
        </div>
    `;
    
    usedPartsList.appendChild(partItem);
    
    // Add event listener to remove button
    partItem.querySelector('.remove-used-part').addEventListener('click', function() {
        partItem.remove();
    });
}

        function addContinueReplacedPart() {
    const partSelect = document.getElementById('continueReplacedPartSelect');
    const selectedPart = partSelect.options[partSelect.selectedIndex].text;
    const partId = partSelect.value;
    const faultDescription = document.getElementById('continueFaultDescription').value;
    
    if (!partId) return;
    
    const replacedPartsList = document.getElementById('continueReplacedPartsList');
    
    // Check if part is already added
    if (replacedPartsList.querySelector(`[data-part-id="${partId}"]`)) {
        showToast('این قطعه قبلا اضافه شده است', 'warning');
        return;
    }
    
    // Create part item
    const partItem = document.createElement('div');
    partItem.className = 'part-item animate__animated animate__fadeIn';
    partItem.dataset.partId = partId;
    
    partItem.innerHTML = `
        <div>
            <div><strong>${selectedPart}</strong></div>
            <div class="text-muted small">${faultDescription || 'شرح عیب وارد نشده'}</div>
        </div>
        <div class="part-actions">
            <button class="btn btn-sm btn-danger remove-replaced-part"><i class="bi bi-trash"></i></button>
        </div>
    `;
    
    replacedPartsList.appendChild(partItem);
    
    // Add event listener to remove button
    partItem.querySelector('.remove-replaced-part').addEventListener('click', function() {
        partItem.remove();
    });
    
    // Clear fault description
    document.getElementById('continueFaultDescription').value = '';
}

        function saveContinueChanges() {
    const modal = document.getElementById('continueWorkModal');
    const partId = modal.dataset.partId;
    const part = parts.find(p => p.id === partId);
    const actionsText = document.getElementById('troubleshootingActionsText');
    if (actionsText) {
        part.troubleshootingActions = actionsText.value;
    }
    
    if (!part) return;
    
    // Update basic info
    part.name = document.getElementById('continuePartName').value;
    part.workingVoltage = document.getElementById('continueWorkingVoltage').value || null;
    part.currentConsumption = document.getElementById('continueCurrentConsumption').value || null;
    
    // Update used parts
    part.usedParts = [];
    document.querySelectorAll('#continueUsedPartsList [data-part-id]').forEach(item => {
        const partId = item.dataset.partId;
        const partName = item.querySelector('span').textContent;
        part.usedParts.push({ id: partId, name: partName });
    });
    
    // Update replaced parts
    part.replacedParts = [];
    document.querySelectorAll('#continueReplacedPartsList [data-part-id]').forEach(item => {
        const partId = item.dataset.partId;
        const partName = item.querySelector('strong').textContent;
        const faultDescription = item.querySelector('.text-muted').textContent;
        part.replacedParts.push({ id: partId, name: partName, faultDescription });
    });
    
    // Files are already updated in the object
    
    // Save changes
    localStorage.setItem('parts', JSON.stringify(parts));
    
    // Close modal
    const continueModal = bootstrap.Modal.getInstance(modal);
    continueModal.hide();
    
    // Remove modal from DOM
    modal.remove();
    
    // Show success message
    showToast('تغییرات با موفقیت ذخیره شد', 'success');
    
    // Update dashboard and parts list
    updateDashboard();
    updatePartsList();
}

        function markContinueAsComplete() {
    const modal = document.getElementById('continueWorkModal');
    const partId = modal.dataset.partId;
    const part = parts.find(p => p.id === partId);
    
    if (!part) return;
    
    // ذخیره اقدامات انجام شده از روی کادر متن
    const actionsText = document.getElementById('troubleshootingActionsText');
    if (actionsText) {
        part.troubleshootingActions = actionsText.value;
    }

    // First save changes
    saveContinueChanges();
    
    // Then mark as complete
    part.completed = true;
    part.completedBy = currentUser.username;
    part.completionDate = new Date().toLocaleDateString('fa-IR');
    localStorage.setItem('parts', JSON.stringify(parts));
    
    showToast('پایان کار برای این برد ثبت شد', 'success');
    updateDashboard();
    updatePartsList();
}    
        function continueWork(partId) {
            const part = parts.find(p => p.id === partId);
            if (!part) return;
            
            // Switch to parts section
            showSection('parts');
            
            // Fill the form with part data
            document.getElementById('partName').value = part.name;
            document.getElementById('partCode').value = part.code;
            document.getElementById('productionDate').value = part.productionDate;
            document.getElementById('workingVoltage').value = part.workingVoltage || '';
            document.getElementById('currentConsumption').value = part.currentConsumption || '';
            
            // Generate QR code
            if (part.code) {
                const barcodeContainer = document.getElementById('continueQrCodeContainer');
barcodeContainer.innerHTML = `<svg id="continueBarcode"></svg>`;
JsBarcode("#continueBarcode", part.code, {
    format: "CODE128",
    lineColor: "#000",
    width: 2,
    height: 60,
    displayValue: true,
    fontSize: 14,
    margin: 10
});
            }
            
            // Fill used parts
            const usedPartsList = document.getElementById('usedPartsList');
            usedPartsList.innerHTML = '';
            part.usedParts.forEach(usedPart => {
                const partItem = document.createElement('div');
                partItem.className = 'part-item animate__animated animate__fadeIn';
                partItem.dataset.partId = usedPart.id;
                
                partItem.innerHTML = `
                    <span>${usedPart.name}</span>
                    <div class="part-actions">
                        <button class="btn btn-sm btn-danger remove-used-part"><i class="bi bi-trash"></i></button>
                    </div>
                `;
                
                usedPartsList.appendChild(partItem);
                
                // Add event listener to remove button
                partItem.querySelector('.remove-used-part').addEventListener('click', () => {
                    partItem.classList.add('animate__fadeOut');
                    setTimeout(() => {
                        partItem.remove();
                    }, 400);
                });
            });
            
            // Fill replaced parts
            const replacedPartsList = document.getElementById('replacedPartsList');
            replacedPartsList.innerHTML = '';
            part.replacedParts.forEach(replacedPart => {
                const partItem = document.createElement('div');
                partItem.className = 'part-item animate__animated animate__fadeIn';
                partItem.dataset.partId = replacedPart.id;
                
                partItem.innerHTML = `
                    <div>
                        <div><strong>${replacedPart.name}</strong></div>
                        <div class="text-muted small">${replacedPart.faultDescription || 'شرح عیب وارد نشده'}</div>
                    </div>
                    <div class="part-actions">
                        <button class="btn btn-sm btn-danger remove-replaced-part"><i class="bi bi-trash"></i></button>
                    </div>
                `;
                
                replacedPartsList.appendChild(partItem);
                
                // Add event listener to remove button
                partItem.querySelector('.remove-replaced-part').addEventListener('click', () => {
                    partItem.classList.add('animate__fadeOut');
                    setTimeout(() => {
                        partItem.remove();
                    }, 400);
                });
            });
            
            // Fill files
            const previewContainer = document.getElementById('filePreviewContainer');
            previewContainer.innerHTML = '';
            uploadedFiles = [...part.files];
            
            part.files.forEach((file, index) => {
                const isImage = file.type.startsWith('image/');
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-preview-item animate__animated animate__fadeIn';
                
                fileItem.innerHTML = `
                    <button class="remove-file" data-file-index="${index}">
                        <i class="bi bi-x"></i>
                    </button>
                    ${isImage ? 
                        `<img src="${file.url}" alt="${file.name}" class="file-preview-img" data-file-index="${index}">` : 
                        `<div class="file-icon"><i class="bi bi-file-earmark"></i></div>`
                    }
                    <div class="file-name">${file.name}</div>
                `;
                
                previewContainer.appendChild(fileItem);
                
                // Add event listener to remove button
                fileItem.querySelector('.remove-file').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(e.currentTarget.dataset.fileIndex);
                    uploadedFiles.splice(index, 1);
                    fileItem.classList.add('animate__fadeOut');
                    setTimeout(() => {
                        fileItem.remove();
                    }, 400);
                });
                
                // Add event listener to preview image
                if (isImage) {
                    fileItem.querySelector('.file-preview-img').addEventListener('click', (e) => {
                        const index = e.target.dataset.fileIndex;
                        previewFile(uploadedFiles[index]);
                    });
                }
            });
            
            // Remove the part from parts array (it will be re-added when saved)
            parts = parts.filter(p => p.id !== partId);
            localStorage.setItem('parts', JSON.stringify(parts));
        }
        
        function updateInventoryTable() {
    const tableBody = document.getElementById('inventoryTable');
    tableBody.innerHTML = '';
    
    if (inventory.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="text-center">هیچ قطعه ای در انبار ثبت نشده است</td></tr>';
        return;
    }
    
    inventory.forEach(item => {
        const row = document.createElement('tr');
        row.className = 'animate__animated animate__fadeIn';
        const statusClass = item.quantity < 3 ? 'low-stock' : '';
        
        row.innerHTML = `
            <td>${item.name}</td>
            <td class="${statusClass}">${item.quantity}</td>
            <td>${item.quantity < 3 ? '<span class="badge bg-danger">موجودی کم</span>' : '<span class="badge bg-success">کافی</span>'}</td>
            <td>
                <button class="btn btn-sm btn-primary edit-inventory" data-inventory-id="${item.id}"><i class="bi bi-pencil"></i></button>
                <button class="btn btn-sm btn-danger delete-inventory" data-inventory-id="${item.id}"><i class="bi bi-trash"></i></button>
            </td>
        `;
        
        tableBody.appendChild(row);
    });
    
    // رویدادهای ویرایش و حذف
    document.querySelectorAll('.edit-inventory').forEach(btn => {
        btn.addEventListener('click', () => {
            const itemId = btn.dataset.inventoryId;
            const item = inventory.find(i => i.id === itemId);
            
            if (item) {
                document.getElementById('inventoryPartName').value = item.name;
                document.getElementById('inventoryQuantity').value = item.quantity;
                document.getElementById('inventoryPartName').focus();
            }
        });
    });
    
    document.querySelectorAll('.delete-inventory').forEach(btn => {
        btn.addEventListener('click', () => {
            if (confirm('آیا از حذف این آیتم از انبار مطمئن هستید؟')) {
                const itemId = btn.dataset.inventoryId;
                inventory = inventory.filter(i => i.id !== itemId);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                updateInventoryTable();
                showToast('آیتم با موفقیت حذف شد', 'success');
            }
        });
    });
}

           // تغییرات در تابع updatePartsList برای افزودن جستجو
        function updatePartsList() {
            const tableBody = document.getElementById('allPartsTable');
            tableBody.innerHTML = '';
            
            if (parts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">هیچ بردی ثبت نشده است</td></tr>';
                return;
            }
            
            parts.forEach(part => {
                const row = document.createElement('tr');
                row.className = 'animate__animated animate__fadeIn';
                
                row.innerHTML = `
                    <td>${part.code}</td>
                    <td>${part.name}</td>
                    <td>${part.createdBy}</td>
                    <td>
                        <span class="status-badge ${part.completed ? 'badge-completed' : 'badge-ongoing'}">
                            ${part.completed ? 'تعمیر شده' : 'در حال انجام'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary view-part-list" data-part-id="${part.id}">
                            <i class="bi bi-eye"></i> مشاهده
                        </button>
                        ${!part.completed || currentUser.isAdmin ? `
                        <button class="btn btn-sm btn-danger delete-part-list" data-part-id="${part.id}">
                            <i class="bi bi-trash"></i> حذف
                        </button>
                        ` : ''}
                    </td>
                `;
                
                tableBody.appendChild(row);
                
                // Add event listener to delete button
                row.querySelector('.delete-part-list')?.addEventListener('click', (e) => {
                    const partId = e.target.closest('button').dataset.partId;
                    const part = parts.find(p => p.id === partId);
                    
                    if (part.completed && !currentUser.isAdmin) {
                        showToast('فقط مدیر سیستم می‌تواند بردهای تعمیر شده را حذف کند', 'danger');
                        return;
                    }
                    
                    deletePart(partId);
                });
                
                // Add event listener to view button
                row.querySelector('.view-part-list').addEventListener('click', (e) => {
                    const partId = e.target.closest('button').dataset.partId;
                    const part = parts.find(p => p.id === partId);
                    if (part) {
                        showPartDetailsModal(part);
                    }
                });
            });
            
            // Add search functionality
            document.getElementById('partsListSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const rows = tableBody.querySelectorAll('tr');
                
                rows.forEach(row => {
                    const code = row.querySelector('td:first-child').textContent.toLowerCase();
                    const name = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    
                    if (code.includes(searchTerm) || name.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }
      
        function populatePartSelects() {
    const usedPartSelect = document.getElementById('usedPartSelect');
    const replacedPartSelect = document.getElementById('replacedPartSelect');
    
    if (!usedPartSelect || !replacedPartSelect) return;
    
    // Clear existing options
    usedPartSelect.innerHTML = '<option value="">انتخاب قطعه...</option>';
    replacedPartSelect.innerHTML = '<option value="">انتخاب قطعه...</option>';
    
    // Add inventory items
    inventory.forEach(item => {
        const option1 = document.createElement('option');
        option1.value = item.id;
        option1.textContent = item.name;
        usedPartSelect.appendChild(option1);
        
        const option2 = document.createElement('option');
        option2.value = item.id;
        option2.textContent = item.name;
        replacedPartSelect.appendChild(option2);
    });
}

     
       
// تابع کمکی برای خروجی اکسل
        function exportToExcel(data, fileName) {
    try {
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "گزارش");
        XLSX.writeFile(wb, `${fileName}.xlsx`);
        showToast('خروجی Excel با موفقیت ایجاد شد', 'success');
    } catch (e) {
        console.error('Error exporting to Excel:', e);
        showToast('خطا در ایجاد خروجی Excel', 'danger');
    }
}

// تابع کمکی برای چاپ گزارش
        function printReport(title, data) {
    const printWindow = window.open('', '_blank');
    const printDate = new Date().toLocaleDateString('fa-IR');
    
    let html = `
        <!DOCTYPE html>
        <html dir="rtl">
        <head>
            <title>${title}</title>
            <meta charset="UTF-8">
            <style>
                body { font-family: 'Vazir', Tahoma; padding: 20px; }
                h1 { text-align: center; margin-bottom: 30px; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
                th { background-color: #f2f2f2; }
                .footer { margin-top: 30px; text-align: left; font-size: 0.9em; }
                .badge { padding: 3px 8px; border-radius: 12px; font-size: 0.85em; }
                .badge-completed { background-color: #d4edda; color: #155724; }
                .badge-ongoing { background-color: #fff3cd; color: #856404; }
            </style>
        </head>
        <body>
            <h1>${title}</h1>
            <p>تاریخ چاپ: ${printDate}</p>
            <table>
                <thead>
                    <tr>
                        <th>ردیف</th>
                        <th>کد برد</th>
                        <th>نام برد</th>
                        <th>تاریخ ثبت</th>
                        <th>وضعیت</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.forEach((part, index) => {
        html += `
            <tr>
                <td>${index + 1}</td>
                <td>${part.code}</td>
                <td>${part.name}</td>
                <td>${new Date(part.createdAt).toLocaleDateString('fa-IR')}</td>
                <td>
                    <span class="badge ${part.completed ? 'badge-completed' : 'badge-ongoing'}">
                        ${part.completed ? 'تعمیر شده' : 'در حال انجام'}
                    </span>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
            <div class="footer">
                <p>تعداد کل: ${data.length} | تعمیر شده: ${data.filter(p => p.completed).length} | در حال انجام: ${data.filter(p => !p.completed).length}</p>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(html);
    printWindow.document.close();
    printWindow.print();
}


// تابع درخواست خرید
        function requestOrder(items) {
    const orderItems = items.map(item => ({
        name: item.name,
        current: item.quantity,
        requested: Math.max(5, item.quantity * 2) // حداقل 5 عدد یا دو برابر موجودی فعلی
    }));
    
    const order = {
        date: new Date().toISOString(),
        requestedBy: currentUser.username,
        items: orderItems,
        status: 'pending'
    };
    
    // ذخیره در localStorage
    const orders = JSON.parse(localStorage.getItem('orders') || '[]');
    orders.push(order);
    localStorage.setItem('orders', JSON.stringify(orders));
    
    showToast('درخواست خرید با موفقیت ثبت شد', 'success');
    
    // نمایش پیام به مدیر
    if (currentUser.isAdmin) {
        alert(`
            درخواست خرید برای ${items.length} قطعه ثبت شد:
            ${items.map(i => `\n- ${i.name} (موجودی: ${i.quantity})`).join('')}
        `);
    }
}       


function generateWorksChart() {
    const year = parseInt(document.getElementById('statsYear').value);
    
    const yearlyParts = parts.filter(part => {
        const partDate = new Date(part.createdAt);
        return partDate.getFullYear() === year;
    });
    
    const completedCount = yearlyParts.filter(part => part.completed).length;
    const ongoingCount = yearlyParts.filter(part => !part.completed).length;
    
    if (worksChart) {
        worksChart.destroy();
    }
    
    const ctx = document.getElementById('worksChart').getContext('2d');
    worksChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['تعمیر شده', 'در حال انجام'],
            datasets: [{
                data: [completedCount, ongoingCount],
                backgroundColor: ['#4cc9f0', '#f8961e'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: `آمار کارها در سال ${year}`,
                    font: {
                        size: 16
                    }
                },
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function generateMonthlyStatsChart() {
    const year = parseInt(document.getElementById('monthlyStatsYear').value);
    
    const monthlyData = Array(12).fill(0).map((_, month) => {
        return parts.filter(part => {
            const partDate = new Date(part.createdAt);
            return partDate.getFullYear() === year && partDate.getMonth() === month;
        }).length;
    });
    
    if (monthlyStatsChart) {
        monthlyStatsChart.destroy();
    }
    
    const ctx = document.getElementById('monthlyStatsChart').getContext('2d');
    monthlyStatsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'],
            datasets: [{
                label: `تعداد بردها در سال ${year}`,
                data: monthlyData,
                backgroundColor: '#4361ee',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'تعداد بردها'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'ماه‌های سال'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `آمار ماهانه بردها در سال ${year}`,
                    font: {
                        size: 16
                    }
                }
            }
        }
    });
}      


        function generateMonthlyStatsChart() {
            const ctx = document.getElementById('monthlyStatsChart').getContext('2d');
            
            // Destroy previous chart if exists
            if (monthlyStatsChart) {
                monthlyStatsChart.destroy();
            }
            
            // Get current year
            const currentYear = new Date().getFullYear();
            
            // Prepare data for each month
            const months = ['فروردین', 'اردیبهشت', 'خرداد', 'تیر', 'مرداد', 'شهریور', 'مهر', 'آبان', 'آذر', 'دی', 'بهمن', 'اسفند'];
            const completedData = [];
            const ongoingData = [];
            
            for (let month = 1; month <= 12; month++) {
                const monthlyParts = parts.filter(part => {
                    const partDate = new Date(part.createdAt);
                    const partYear = partDate.getFullYear();
                    const partMonth = partDate.getMonth() + 1;
                    
                    return partYear === currentYear && partMonth === month;
                });
                
                completedData.push(monthlyParts.filter(p => p.completed).length);
                ongoingData.push(monthlyParts.filter(p => !p.completed).length);
            }
            
            monthlyStatsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'کارهای تکمیل شده',
                            data: completedData,
                            backgroundColor: 'rgba(76, 201, 240, 0.7)',
                            borderColor: 'rgba(76, 201, 240, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'کارهای در حال انجام',
                            data: ongoingData,
                            backgroundColor: 'rgba(248, 150, 30, 0.7)',
                            borderColor: 'rgba(248, 150, 30, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: true,
                            labels: {
                                font: {
                                    family: 'Vazir, sans-serif'
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'آمار ماهانه کارها',
                            font: {
                                family: 'Vazir, sans-serif',
                                size: 16
                            }
                        },
                        tooltip: {
                            bodyFont: {
                                family: 'Vazir, sans-serif'
                            },
                            titleFont: {
                                family: 'Vazir, sans-serif'
                            }
                        }
                    }
                }
            });
        }
        
      
       
      
        async function exportPartDetailsAsExcel() {
    try {
        const partId = document.getElementById('partDetailsModal').dataset.partId;
        const part = parts.find(p => p.id === partId);
        
        if (!part) {
            showToast('برد مورد نظر یافت نشد', 'danger');
            return;
        }

        // ایجاد یک workbook جدید
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('جزئیات برد');

        // تنظیم راست به چپ برای شیت
        worksheet.views = [{ rightToLeft: true }];

        // تعریف استایل‌ها
        const headerStyle = {
            font: { bold: true, size: 12 },
            alignment: { horizontal: 'right', vertical: 'middle' },
            border: {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            },
            fill: {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFD9D9D9' }
            }
        };

        const valueStyle = {
            font: { size: 12 },
            alignment: { horizontal: 'right', vertical: 'middle' },
            border: {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            }
        };

        const sectionHeaderStyle = {
            font: { bold: true, size: 12 },
            alignment: { horizontal: 'right', vertical: 'middle' },
            border: {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            },
            fill: {
                type: 'pattern',
                pattern: 'solid',
                fgColor: { argb: 'FFE6E6E6' }
            }
        };

        // تابع کمکی برای افزودن ردیف با ادغام ایمن
        const addMergedRow = (worksheet, text, style) => {
            const row = worksheet.addRow([text, '']);
            row.eachCell(cell => {
                cell.style = style;
            });
            worksheet.mergeCells(`A${row.number}:B${row.number}`);
            return row.number;
        };

        // تابع کمکی برای افزودن ردیف عادی
        const addNormalRow = (worksheet, label, value, labelStyle, valueStyle) => {
            const row = worksheet.addRow([label, value]);
            row.getCell(1).style = labelStyle;
            row.getCell(2).style = valueStyle;
            return row.number;
        };

        // افزودن اطلاعات اصلی برد
        addNormalRow(worksheet, 'نام برد:', part.name, headerStyle, valueStyle);
        addNormalRow(worksheet, 'کد برد:', part.code, headerStyle, valueStyle);
        addNormalRow(worksheet, 'تاریخ تولید:', part.productionDate, headerStyle, valueStyle);
        addNormalRow(worksheet, 'ولتاژ کاری:', part.workingVoltage || 'ثبت نشده', headerStyle, valueStyle);
        addNormalRow(worksheet, 'جریان مصرفی:', part.currentConsumption || 'ثبت نشده', headerStyle, valueStyle);
        addNormalRow(worksheet, 'ثبت شده توسط:', part.createdBy, headerStyle, valueStyle);
        addNormalRow(worksheet, 'تاریخ ثبت:', new Date(part.createdAt).toLocaleDateString('fa-IR'), headerStyle, valueStyle);
        
        if (part.completed) {
            addNormalRow(worksheet, 'تکمیل شده توسط:', part.completedBy, headerStyle, valueStyle);
            addNormalRow(worksheet, 'تاریخ تکمیل:', part.completionDate, headerStyle, valueStyle);
        }
        
        addNormalRow(worksheet, 'شرح عیب:', part.faultDescription || 'ثبت نشده', headerStyle, valueStyle);

        // افزودن یک سطر خالی
        worksheet.addRow([]);

        // افزودن قطعات بکار رفته
        const usedPartsHeaderRow = addMergedRow(worksheet, 'قطعات بکار رفته:', sectionHeaderStyle);
        
        if (part.usedParts.length > 0) {
            // هدر جدول قطعات بکار رفته
            addNormalRow(worksheet, 'نام قطعه', 'تعداد', headerStyle, headerStyle);
            
            part.usedParts.forEach(usedPart => {
                addNormalRow(worksheet, usedPart.name, '1', valueStyle, valueStyle);
            });
        } else {
            addMergedRow(worksheet, 'قطعه ای ثبت نشده است', valueStyle);
        }
        
        // افزودن یک سطر خالی
        worksheet.addRow([]);

        // افزودن قطعات تعویض شده
        const replacedPartsHeaderRow = addMergedRow(worksheet, 'قطعات تعویض شده:', sectionHeaderStyle);
        
        if (part.replacedParts.length > 0) {
            // هدر جدول قطعات تعویض شده
            addNormalRow(worksheet, 'نام قطعه', 'تعداد', headerStyle, headerStyle);
            
            part.replacedParts.forEach(replacedPart => {
        const rowNumber = addNormalRow(
            worksheet, 
            replacedPart.name, 
            replacedPart.quantity || '1', 
            valueStyle, 
            {
                ...valueStyle,
                alignment: { 
                    ...valueStyle.alignment,
                    horizontal: 'right' // راست‌چین کردن مقدار تعداد
                }
            }
        );
        
        // اعمال تراز راست برای سلول تعداد
        worksheet.getCell(`B${rowNumber}`).alignment = {
            horizontal: 'right',
            vertical: 'middle'
        };
    });
} else {
    addMergedRow(worksheet, 'قطعه ای ثبت نشده است', valueStyle);
}
        
        // افزودن یک سطر خالی
        worksheet.addRow([]);

        // افزودن وضعیت
        addNormalRow(worksheet, 'وضعیت:', part.completed ? 'تعمیر شده' : 'در حال انجام', headerStyle, valueStyle);

        // افزودن یک سطر خالی
        worksheet.addRow([]);

        // افزودن اقدامات انجام شده جهت رفع عیب
        const actionsHeaderRow = addMergedRow(worksheet, 'اقدامات انجام شده جهت رفع عیب:', sectionHeaderStyle);
        
        const actionsRow = worksheet.addRow([part.troubleshootingActions || 'ثبت نشده', '']);
        actionsRow.eachCell(cell => {
            cell.style = valueStyle;
            cell.alignment = { 
                horizontal: 'right', 
                vertical: 'middle',
                wrapText: true 
            };
        });
        worksheet.mergeCells(`A${actionsRow.number}:B${actionsRow.number}`);
        
        // افزودن یک سطر خالی
        worksheet.addRow([]);

        // افزودن فایل های مرتبط
        const filesHeaderRow = addMergedRow(worksheet, 'فایل های مرتبط:', sectionHeaderStyle);
        
        if (part.files.length > 0) {
            part.files.forEach(file => {
                addMergedRow(worksheet, file.name, valueStyle);
            });
        } else {
            addMergedRow(worksheet, 'فایلی ثبت نشده است', valueStyle);
        }

        // تنظیم عرض ستون‌ها
        worksheet.columns = [
            { width: 30 },
            { width: 50 }
        ];

        // تولید فایل اکسل
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `جزئیات_برد_${part.name}_${part.code}.xlsx`;
        a.click();
        URL.revokeObjectURL(url);

        showToast('خروجی اکسل با موفقیت ایجاد شد', 'success');
    } catch (error) {
        console.error('خطا در ایجاد فایل اکسل:', error);
        showToast('خطا در ایجاد فایل اکسل', 'danger');
    }
}
        
        function exportAllData() {
            // Create a new workbook
            const wb = XLSX.utils.book_new();
            
            // Create parts worksheet
            const partsData = [['کد برد', 'نام برد', 'وضعیت', 'تاریخ تولید', 'ثبت شده توسط', 'تکمیل شده توسط', 'تاریخ تکمیل']];
            parts.forEach(part => {
                partsData.push([
                    part.code,
                    part.name,
                    part.completed ? 'تعمیر شده' : 'در حال انجام',
                    part.productionDate,
                    part.createdBy,
                    part.completedBy || '-',
                    part.completionDate || '-'
                ]);
            });
            const partsWS = XLSX.utils.aoa_to_sheet(partsData);
            XLSX.utils.book_append_sheet(wb, partsWS, "بردهای تعمیری");
            
            // Create inventory worksheet
            const inventoryData = [['نام قطعه', 'موجودی', 'وضعیت']];
            inventory.forEach(item => {
                inventoryData.push([
                    item.name,
                    item.quantity,
                    item.quantity < 3 ? 'موجودی کم' : 'کافی'
                ]);
            });
            const inventoryWS = XLSX.utils.aoa_to_sheet(inventoryData);
            XLSX.utils.book_append_sheet(wb, inventoryWS, "موجودی انبار");
            
            // Export the workbook
            XLSX.writeFile(wb, `گزارش_کلی_${new Date().toLocaleDateString('fa-IR')}.xlsx`);
        }
        
        function updateUsersTable() {
            users.forEach(user => {
    if (!user) {
        console.error("خطا: مقدار `user` در `forEach` برابر `null` است!");
    } else {
        console.log("در حال پردازش کاربر:", user);
    }
});

    const tableBody = document.getElementById('usersTableBody');
    tableBody.innerHTML = '';
    users.forEach(user => {
    if (!user) {
        console.error("خطا: مقدار `user` در `forEach` برابر `null` است!");
    } else {
        console.log("در حال پردازش کاربر:", user);
    }
});

    // مقداردهی صحیح `users`
    let users = JSON.parse(localStorage.getItem('users')) || []; 

    users.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.username}</td>
            <td>${user.isAdmin ? 'مدیر سیستم' : 'کاربر عادی'}</td>
            <td>
                <button class="btn btn-sm btn-primary edit-user" data-username="${user.username}">
                    <i class="bi bi-pencil"></i>
                </button>
                ${user.username !== 'admin' ? `
                <button class="btn btn-sm btn-danger delete-user" data-username="${user.username}">
                    <i class="bi bi-trash"></i>
                </button>
                ` : ''}
            </td>
        `;
        tableBody.appendChild(row);
    });

    // اضافه کردن رویدادهای ویرایش و حذف
    document.querySelectorAll('.edit-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const username = this.dataset.username;
            editUser(username);
        });
    });

    document.querySelectorAll('.delete-user').forEach(btn => {
        btn.addEventListener('click', function() {
            const username = this.dataset.username;
            deleteUser(username);
        });
    });

   // console.log("جدول کاربران با موفقیت بروزرسانی شد:", users);
}

function addNewUser() {
    // ریست فرم
    document.getElementById('editUsername').value = '';
    document.getElementById('editPassword').value = '';
    document.getElementById('editIsAdmin').checked = false;
    
    // نمایش checkbox برای مدیر
    document.getElementById('adminCheckboxContainer').style.display = 'block';
    
    // تنظیم عنوان مودال
    document.getElementById('userEditModalLabel').textContent = 'افزودن کاربر جدید';
    
    // نمایش مودال
    userEditModal.show();
}

    // تنظیمات فرم
    document.getElementById('userEditModalLabel').textContent = 'افزودن کاربر جدید';
    document.getElementById('editUsername').value = '';
    document.getElementById('editPassword').value = '';
    document.getElementById('userEditError').classList.add('d-none');
    document.getElementById('editUsername').readOnly = false;
    document.getElementById('adminCheckboxContainer').style.display = 
        currentUser.isAdmin ? 'block' : 'none';

    // نمایش مودال با روش تضمینی
    modalEl.style.display = 'block';
    modalEl.classList.add('show');
    modalEl.setAttribute('aria-hidden', 'false');
    document.body.classList.add('modal-open');
    
    // ایجاد backdrop دستی
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade show';
    document.body.appendChild(backdrop);

    // فوکوس روی اولین فیلد
    setTimeout(() => {
        document.getElementById('editUsername').focus();
    }, 100);


        function editUser(username) {
    const user = users.find(u => u.username === username);
    if (!user) return;
    
    document.getElementById('editUsername').value = user.username;
    document.getElementById('editPassword').value = '';
    document.getElementById('editIsAdmin').checked = user.isAdmin || false;
    
    // نمایش بخش دسترسی مدیر فقط برای مدیر سیستم
    document.getElementById('adminCheckboxContainer').style.display = 
        currentUser.isAdmin ? 'block' : 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('userEditModal'));
    modal.show();
}

        function changeUserPassword(username) {
            const user = users.find(u => u.username === username);
            
            if (user) {
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                document.getElementById('passwordError').classList.add('d-none');
                
                // Temporarily store the username we're changing password for
                document.getElementById('changePasswordModal').dataset.username = username;
                
                const changePasswordModal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
                changePasswordModal.show();
            }
        }
        
        function saveUser() {
            const username = document.getElementById('editUsername').value;
            const password = document.getElementById('editPassword').value;
            const isAdmin = document.getElementById('editIsAdmin') ? document.getElementById('editIsAdmin').checked : false;
            const errorElement = document.getElementById('userEditError');
            
            if (!username || !password) {
                errorElement.textContent = 'لطفا نام کاربری و رمز عبور را وارد کنید';
                errorElement.classList.remove('d-none');
                return;
            }
            
            if (password.length < 4) {
                errorElement.textContent = 'رمز عبور باید حداقل 4 کاراکتر باشد';
                errorElement.classList.remove('d-none');
                return;
            }
            
            // Check if we're adding a new user or editing an existing one
            const isNewUser = !users.some(u => u.username === username);
            
            if (isNewUser) {
                // Add new user
                users.push({
                    username,
                    password,
                    isAdmin,
                    changePassword: false,
                    name: username
                });
                
                localStorage.setItem('users', JSON.stringify(users));
                
                const userEditModal = bootstrap.Modal.getInstance(document.getElementById('userEditModal'));
                userEditModal.hide();
                
                showToast('کاربر جدید با موفقیت اضافه شد', 'success');
            } else {
                // Update existing user
                const userIndex = users.findIndex(u => u.username === username);
                if (userIndex !== -1) {
                    users[userIndex].password = password;
                    
                    // Only admin can change admin status
                    if (currentUser.isAdmin) {
                        users[userIndex].isAdmin = isAdmin;
                    }
                    
                    localStorage.setItem('users', JSON.stringify(users));
                    
                    const userEditModal = bootstrap.Modal.getInstance(document.getElementById('userEditModal'));
                    userEditModal.hide();
                    
                    showToast('اطلاعات کاربر با موفقیت به روز شد', 'success');
                }
            }
            
            updateUsersTable();
        }
        
        function deleteUser(username) {
            if (confirm(`آیا از حذف کاربر "${username}" مطمئن هستید؟`)) {
                users = users.filter(u => u.username !== username);
                localStorage.setItem('users', JSON.stringify(users));
                updateUsersTable();
                showToast('کاربر با موفقیت حذف شد', 'success');
            }
        }
        
        function showToast(message, type) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            // Add toast to container
            const toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
            toastContainer.style.zIndex = '1100';
            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);
            
            // Initialize and show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            
            // Remove toast after it's hidden
            toast.addEventListener('hidden.bs.toast', () => {
                toastContainer.remove();
            });
        }

        function setupExportExcelButton() {
  const exportBtn = document.getElementById('exportExcelBtn');
  if (!exportBtn) return;

  exportBtn.onclick = handleExcelExport;
}

function handleExcelExport() {
  try {
    const modal = document.getElementById('partDetailsModal');
    if (!modal || !modal.dataset.partId) {
      showToast('لطفاً ابتدا جزئیات برد را باز کنید', 'warning');
      return;
    }
    exportPartDetailsAsExcel();
  } catch (error) {
    console.error('خطا در مدیریت اکسل:', error);
    showToast('خطا در عملکرد دکمه اکسل', 'danger');
  }
}

    </script>
</body>
</html>